%! TEX root = main.tex

%/========== Virtual Nonholonomic Constraints ==========/%

\chapter{Development of Virtual Nonholonomic Constraints}\label{ch:vnhcs}

\section{Preliminaries on Analytical Mechanics}
A mechanical system can be represented by \(N\) point masses where each point
represents the center of mass of a physical body, along with \(r\)
\textit{equations of constraint} (EOC) which model the physical restrictions
between these masses.
The position of each point mass is described using three cartesian coordinates (one
for each spatial axis), so the system as a whole can be described by a vector in
\(\R^{3N}\) with \(r\) EOC. 
The dynamics of the system are computed by deriving the \(3N\)
\textit{equations of motion} (EOM) produced by Newton's second law \(F = m a\).
While this technique works for simple systems, it is tedius and becomes
impossible to apply to complex mechanical systems where the forces are not
explicitly known. 

Rather than modeling a mechanical system by cartesian positions and constraints,
it is often feasible to represent the position of the system using \(n\)
independent scalar-valued variables \(q_1,\ldots,q_n\) called 
\textit{generalized coordinates}, where \(n = 3N - r\) is the number of
\textit{degrees of freedom} (DOF) of the system \cite{greenwood_dynamics}. For
instance, Figure \ref{fig:barbell} shows a barbell on a \(2D\)-plane which can
rotate freely on that plane. 
The barbell has \(n = 3\) DOF, so it can be described by three
independent generalized coordinates with no equations of constraint.

\begin{figure}
   \centering
   \begin{subfigure}[]{0.75\textwidth}
      \includestandalone[width=\textwidth]{images/newtonian_barbell}
      \caption{The Newtonian representation of the barbell 
      requires all six cartesian positions and the corresponding EOC.}
   \end{subfigure}
   \begin{subfigure}[]{0.75\textwidth}
      \includestandalone[width=\textwidth]{images/gc_barbell}
      \caption{One possible set of three generalized coordinates is
       \((x_0,y_0,\theta)\), which represent the position of the 
       center of the bar and the angle of the barbell in the \(xy\)-plane.}
   \end{subfigure}
   \caption{A mechanical system with \(N = 2\) point masses at \(a = (x_1,y_1,z_1)\)
       and \(b = (x_2,y_2,z_2)\), separated by a bar of length \(c\). 
       There are \(r = 3\) EOC given by \(\norm{a - b} = c\), \(z_1 = 0\),
       and \(z_2 = 0\). This system has \(n = 3\) degrees of freedom.}
   \label{fig:barbell}
\end{figure}

For the robotic systems of interest in this thesis, we assume that
each generalized coordinate \(q_i\) represents either the distance or the angle
between two parts of the system.
Mathematically, each \(q_i\) takes values in \(\Rt{T_i}\), where
\(T_i = \infty\) if \(q_i\) represents a length or \(T_i = 2\pi\) if \(q_i\)
represents an angle.
It is convention to collect the coordinates into a \textit{configuration} 
\(q = (q_1,\ldots,q_n) \in \mathcal{Q}\) 
where the \textit{configuration manifold} \(\mathcal{Q}\) of the system is a
so-called \textit{generalized cylinder}
\[
    \mathcal{Q} = \Rt{T_1} \times \cdot \times \Rt{T_n}
    .
\] 
The derivative \(\dot{q} = (\dot{q}_1,\ldots,\dot{q}_n)\) of a configuration
is called a \textit{generalized velocity} of the system. For arbitrary systems,
the space of allowable velocities depends on the current configuration of the
system.  However, since \(\mathcal{Q}\) is a generalized cylinder, we find that 
\(\dot{q} \in \R^n\).
The combined vector \((q,\dot{q}) \in \mathcal{Q}\times\R^n\) is called a 
\textit{state} of the system.

The field of analytical mechanics provides a computational method for finding
the EOM of a system in generalized coordinates. The two most common analytical
methods for modelling robotic systems are \textit{Lagrangian} and
\textit{Hamiltonian} mechanics.

% ---------- Lagrangian Mechanics ---------- % 
\subsection{Lagrangian Mechanics}\label{sec:lagrangian-mechanics}

Lagrangian mechanics uses the kinetic energy \(T(q,\dot{q})\) and potential
energy \(P(q)\) of the system to define the Lagrangian 
\(\mathcal{L} : \mathcal{Q}\times\R^n \rightarrow \R\) defined by
~\eqref{eqn:lagrangian-general} \cite{greenwood_dynamics},
\begin{equation}\label{eqn:lagrangian-general}
    \mathcal{L}(q,\dot{q}) = T(q,\dot{q}) - P(q)
    .
\end{equation}
When the mechanical system is actuated, the EOM are described by \(n\) second-order
ordinary differential equations (ODEs) obtained from the \textit{Euler-Lagrange
equations} ~\eqref{eqn:el-eqns-general} with \textit{generalized input forces} 
\(\tau \in \R^k\)
\begin{equation}\label{eqn:el-eqns-general}
    \diff{}{t}\left\{ \pdiff{\mathcal{L}}{\dot{q}_i} \right\}
    - \pdiff{\mathcal{L}}{q_i} = B_i\tpose(q) \tau
    .
\end{equation}
The vector \(B_i\tpose: \mathcal{Q} \rightarrow \R^{1\times k}\) describes how
the input forces shape the dynamics of \(q_i\).
The matrix  \(B: \mathcal{Q} \rightarrow \R^{n \times k}\) with
\[
    B(q) = \begin{bmatrix}
        - & B_1\tpose(q) & - \\
          & \vdots & \\
        - & B_n\tpose(q) & - \\
    \end{bmatrix}
    ,
\]
is called the \textit{input matrix} for the system.
If \(k < n\), we say the system is \textit{underactuated} with degree of
underactuation \((n - k)\).

Many actuated mechanical systems have quadratic kinetic energies, so that the
Lagrangian can be written explicitly as
\begin{equation}\label{eqn:lagrangian}
    \mathcal{L}(q,\dot{q}) = \frac{1}{2} \dot{q}\tpose D(q) \dot{q} - P(q)
    ,
\end{equation}
where the \textit{inertia matrix} \(D: \mathcal{Q} \rightarrow \R^{n\times n}\) 
is a symmetric, positive definite matrix for all \(q \in \mathcal{Q}\) and the
potential function \(P : \mathcal{Q} \rightarrow \R\) is smooth. 
%If this is the case, the Euler-Lagrange equations reduce to ~\eqref{eqn:el-eqns},
%\begin{equation}\label{eqn:el-eqns}
%    D(q)\ddot{q} + C(q,\dot{q})\dot{q} + \nabla P(q) = B(q)\tau
%\end{equation}
%where the \textit{Coriolis matrix} \(C(q,\dot{q})\) is of the form
%\[
%    [C]_{i,j} = \frac{1}{2}\sum\limits_{k = 1}^n 
%    \left(\pdiff{D_{i,j}}{q_k}  +
%     \pdiff{D_{i,k}}{q_j} -
%     \pdiff{D_{k,j}}{q_i}\right)\dot{q}_k
%\]

% ---------- Hamiltonian Mechanics ---------- %
\subsection{Hamiltonian Mechanics}
Hamiltonian mechanics converts the \(n\) second-order ODEs generated by
Lagrangian mechanics into an equivalent set of \(2n\) first-order ODEs.

To do this, we first define the \textit{conjugate of momentum \(p_i\) to \(q_i\)} by
\begin{equation}\label{eqn:p-i}
    p_i(q,\dot{q}) := \pdiff{\mathcal{L}}{\dot{q}_i}(q,\dot{q})
    .
\end{equation}
To ease notation, we write \(p = (p_1, \ldots, p_n) \in \R^n\) and call
\(p\) the \textit{conjugate of momenta to \(q\)}.
Note that each \(p_i\) is a linear function of \(\dot{q}\), and one can typically
solve for \(\dot{q}(q,p)\) by inverting all the expressions from ~\eqref{eqn:p-i}.
The combined vector \((q,p) \in \mathcal{Q}\times\R^n\) is called a 
\textit{phase} of the system. 

The \textit{Hamiltonian} of the system in
\((q,p)\) coordinates is the ``Legendre transform"
~\eqref{eqn:hamiltonian-legendre} of the Lagrangian \cite{landau_mechanics},
\begin{equation}\label{eqn:hamiltonian-legendre}
    \mathcal{H}(q,p) := p\tpose \dot{q}(q,p) - \mathcal{L}(q,\dot{q}(q,p))
    .
\end{equation}
The EOM in the Hamiltonian framework are the \(2n\)
first-order equations called \textit{Hamilton's equations}. They are given by
\begin{equation}\label{eqn:hamiltons-eqns}
    \begin{cases}
        \dot{q} = \nabla_p\mathcal{H} \\
        \dot{p} = -\nabla_q\mathcal{H} + B(q)\tau
        .
    \end{cases}
\end{equation}
Here, \(B(q) \in \R^{n\times k}\) is the same input matrix used by the
Lagrangian framework, with \(\tau \in \R^k\) the same vector of generalized
input forces.

If the kinetic energy of the system is quadratic as in ~\eqref{eqn:lagrangian}, 
the conjugate of momenta becomes \(p = D(q)\dot{q}\). Since \(D(q)\) is symmetric
and positive definite, it is invertible at each \(q \in \mathcal{Q}\).
The Legendre transform ~\eqref{eqn:hamiltonian-legendre} becomes
\begin{align*}
    \mathcal{H}(q,p) &= p\tpose D\inv(q)p - \left( \frac{1}{2}p\tpose D\inv(q) p -
    P(q) \right) \\
         &= \frac{1}{2} p\tpose D^{-1}(q) p + P(q)
    .
\end{align*}
Finding the derivative of each momentum coordinate yields
\[
    \dot{p}_i = -\frac{1}{2} p\tpose \nabla_{q_i}D\inv(q) p 
        - \pdiff{P}{q_i}(q) + B_i\tpose(q) \tau
    .
\]
Recall the Kronecker product of matrices \cite{kronprod}, defined as follows.
\begin{defn}
    Let \(A \in \R^{n \times m}\) and \(B \in \R^{r \times s}\).
    The Kronecker product \(A \otimes B \in \R^{nr \times ms}\) is the  matrix
    \[
        A \otimes B = \begin{bmatrix}
            a_{1,1}B & \cdots & a_{1,m} B \\
            \vdots & \ddots & \vdots \\
            a_{n,1} B & \cdots & a_{n,m} B
        \end{bmatrix} 
        .
    \]
\end{defn}
Using the kronecker product, one can collect the derivative of momentum into
the vector form
\[
    \dot{p} = -\frac{1}{2} (\Id{n} \otimes p\tpose) \nabla_q D\inv(q) p
    - \nabla_q P(q) + B(q) \tau
    .
\]
In sum, when the kinetic energy is quadratic the Hamiltonian system reduces to
\begin{align}\label{eqn:hamiltonian}
    \mathcal{H}(q,p) &= \frac{1}{2} p\tpose D^{-1}(q) p + P(q)
    , \\
     &\begin{cases}
        \dot{q} = D\inv(q)p \\
        \dot{p} = -\frac{1}{2} (\Id{n} \otimes p\tpose) \nabla_q D\inv(q) p
        - \nabla_q P(q) + B(q) \tau
        . \\
    \end{cases} \label{eqn:hamiltonian-full-dynamics}
\end{align}

Any set of coordinates \((q,p)\) which satisfy Hamilton's equations 
under the Hamiltonian \(\mathcal{H}\) are
said to be \textit{canonical coordinates} for the system. A change of
coordinates \((q,p) \rightarrow (Q,P)\) is a \textit{canonical
transformation} if \((Q,P)\) preserve the Hamiltonian structure; that is, if
they are canonical coordinates under the Hamiltonian
\(\mathcal{H}\left(q(Q,P), p(Q,P)\right)\).

\citet{landau_mechanics} provide a useful result for showing whether a given
change of coordinates \((q,p) \to (Q,P)\) is a canonical transformation.
\begin{defn}
    The \textit{Poisson bracket} between the functions \(f(q,p)\) and \(g(q,p)\)
    is
    \begin{equation}\label{eqn:poisson-bracket}
        [f,g] := \sum \limits_{i=1}^n \pdiff{f}{p_i}\pdiff{g}{q_i} - 
            \pdiff{f}{q_i}\pdiff{g}{p_i}
        .
    \end{equation}
\end{defn}
\begin{thm}\label{thm:canonical-transformations}
    A change of coordinates 
    \((q,p) \to (Q,P)\) is a canonical transformation if and only if
    \begin{align*}
        [Q_i, Q_j] &= 0
        , \\
        [P_i, P_j] &= 0
        , \\
        [P_i, Q_j] &= \delta_{i,j}
        , 
    \end{align*}
    for all \(i,j \in \n\).
\end{thm}
\begin{proof}
    See (45.10) in \cite{landau_mechanics}.
\end{proof}

Later in this chapter we will define a particular change of coordinates.
The following Lemma allows us to prove it is a canonical transformation.

\begin{lemma}\label{lemma:linear-is-canonical}
    Let \(\mathcal{H}\) be a Hamiltonian system in canonical coordinates
    \((q,p)\).
    Let \(A \in \R^{n\times n}\) be an orthogonal matrix.
    The change of coordinates \((q,p) \to (Q = Aq, P = Ap)\) is a canonical
    transformation.
\end{lemma}
\begin{proof}
    For any constant matrix \(A\), the transformation
    \((Q = Aq, P = Ap)\) satisfies
    \(\pdiff{Q_i}{p_m} = \pdiff{P_i}{q_m} = 0\) for all 
    \(i,m \in \n\).
    Hence, 
    \begin{align*}
        [Q_i,Q_j] &= \sum\limits_{m = 1}^n \pdiff{Q_i}{p_m}\pdiff{Q_j}{q_m} - 
        \pdiff{Q_i}{q_m}\pdiff{Q_j}{p_m} = 0
        , \\
        [P_i,P_j] &= \sum\limits_{m=1}^n \pdiff{P_i}{p_m}\pdiff{P_j}{q_m} -
        \pdiff{P_i}{q_m}\pdiff{P_j}{p_m} = 0
        .
    \end{align*}
    Note that \((A_i)\tpose (A\tpose)_j = (A_i)\tpose (A\inv)_j = \delta_{i,j}\). 
    Using this fact we see that the Poisson brackets between \(P_i\) and \(Q_j\)
    are given by
    \begin{align*}
        [P_i,Q_j] &= \sum\limits_{m=1}^n\pdiff{P_i}{p_m}\pdiff{Q_j}{q_m}
        - \pdiff{P_i}{q_m}\pdiff{Q_j}{p_m} \\
                  &= \sum\limits_{m=1}^n A_{i,m}A_{j,m} - 0 \\
                  &= \sum\limits_{m=1}^n A_{i,m}(A\tpose)_{m,j} \\
                  &= (A_i)\tpose (A\tpose)_j \\
                  &= \delta_{i,j}
        .
    \end{align*}
    Therefore, by Theorem \ref{thm:canonical-transformations}, the coordinate
    change \((Q = Aq, P = Ap)\) is a canonical transformation.
\end{proof}

\section{Simply Actuated Hamiltonian Systems}\label{sec:simply-actuated}
% Describe the change of coordinates to get into q_u/q_a mode and show
% that the actuator directly affects pa but not pu. Use M for simply actuated
% inertia, D for normal coordinates
Suppose we are given a Hamiltonian mechanical system ~\eqref{eqn:hamiltonian}.
Because \(\tau\) is transformed by the input matrix \(B(q)\) before
entering the EOM, it is not in general clear how any particular input force \(\tau_i\)
will affect the dynamics of the system. 
In this section, we define a new class of Hamiltonian systems where the effect
of the input forces is made obvious. This class of
systems will form the backbone for the rest of the theory developed in this
thesis.

\begin{defn}
    Let \(\mathcal{H}\) be an \(n\)-DOF Hamiltonian system 
    with \(k \leq n\) actuators. 
    A set of canonical coordinates \((q,p)\) for this system
    are said to be \textit{simply actuated coordinates} if the
    input matrix \(B(q) \in \R^{n \times k}\) is of the form
    \[
        B(q) = \simpleB    
        .
    \]
    The first \((n-k)\) coordinates, labelled \(q_u\), are called the
    \textit{unactuated coordinates}. The remaining \(k\) coordinates, labelled
    \(q_a\), are called the \textit{actuated coordinates}. When grouping them
    together, we will always put them in the order \((q_u, q_a)\) to fit with 
    the definition. 
    The corresponding \((p_u, p_a)\) are called the \textit{unactuated} and 
    \textit{actuated momenta}, respectively.
\end{defn}

Under the following assumptions on the input matrix, we will show that there is
a canonical transformation of ~\eqref{eqn:hamiltonian} into simply actuated
coordinates.

\begin{assm}\label{assm:B-const}
    The input matrix \(B(q) \equiv B \in \R^{n\times k}\) is constant,
    full rank, and \(k < n\).
\end{assm}
\begin{assm}\label{assm:B-perp}
    There exists a matrix 
    \(B^\perp \in \R^{(n-k)\times n}\)
    which is right semi-orthogonal 
    \(\left(B^\perp(B^\perp)\tpose = \Id{(n-k)}\right)\)
    and which is a left-annihilator for \(B\). 
    That is, \(B^\perp B = \Zmat{(n-k) \times k}\).
\end{assm}

Assumption \ref{assm:B-perp} requires the rows of \(B^\perp\) to be unit vectors
that are mutually orthogonal. 
In the case that \(k = (n-1)\), the existence of any left annihilator 
\(A^0 \in \R^{1\times n}\) implies the left annihilator 
\(B^\perp := A^0/\norm{A^0}\) will be a unit vector satisfying Assumption \ref{assm:B-perp}.

\begin{lemma}\label{lemma:B-orthogonal}
    Suppose Assumption \ref{assm:B-const} holds. Then
    there exists a nonsingular matrix \(\hat{T} \in \R^{k \times k}\) 
    so that the regular feedback transformation 
    \[
        \tau = \hat{T} \hat{\tau}
    \] 
    has a new input matrix \(\hat{B}\) for \(\hat{\tau}\) which is left
    semi-orthogonal.  
    That is, \(\hat{B}\tpose \hat{B} = \Id{k}\).
\end{lemma}
\begin{proof}
Since \(B\) is a constant matrix, 
it has a singular-value decomposition 
\(B = U \Sigma V\tpose\) where \(U^{-1} = U\tpose \in \R^{n \times n}\), 
\(V^{-1} = V\tpose \in \R^{k \times k}\), and \(\Sigma \in \R^{n \times k}\) is
defined by
\[
    \Sigma = \begin{bmatrix}
        \sigma_1 & 0 & \cdots & 0 \\
        0 & \sigma_2 & \cdots & 0 \\
        \vdots & & \ddots & \vdots \\
        0 & 0 & \cdots & \sigma_k \\
        - &   & \Zmat{(n-k)\times k} & -  \\
    \end{bmatrix}
    ,
\]
where \(\sigma_i \neq 0\) because \(B\) is full-rank \cite{calculating_svd}.
Define \(T \in \R^{k \times k}\) by
\[
    T = \begin{bmatrix}
        \frac{1}{\sigma_1} & 0 & \cdots & 0 \\
        0 & \frac{1}{\sigma_2} & \cdots & 0 \\
    \vdots & & \ddots & \vdots \\
    0 & 0 & \cdots & \frac{1}{\sigma_k} \\
    \end{bmatrix}
    .
\]
Letting \(\hat{T} = V T\) and assigning the regular feedback
transformation \(\tau = \hat{T} \hat{\tau}\), 
we get a new input matrix for \(\hat{\tau} \in \R^k\) given by 
\[
    \hat{B} = B \hat{T} = B V T = 
    U \begin{bmatrix}
        \Id{k} \\ \Zmat{(n-k)\times k}
    \end{bmatrix}
    ,
\]
which is still constant and full-rank. 
In particular, 
\(\hat{B}\tpose \hat{B} = T\tpose \Sigma\tpose \Sigma T = \Id{k}\).
\end{proof}

In light of Lemma \ref{lemma:B-orthogonal}, there is no loss of generality
by making the following assumption.
\begin{assm}\label{assm:B-orthogonal}
    Assume that the input matrix \(B\) is
    left semi-orthogonal, \ie, \(B\tpose B = I_k\). 
\end{assm}

Let now \(\mathbf{B} \in \R^{n\times n}\) be the following matrix:
\[
    \mathbf{B} = 
    \begin{bmatrix}
        B^\perp \\
        B\tpose \\
    \end{bmatrix}
    .
\]
Since \(B^\perp\) is a left annihilator of \(B\) and both \(B^\perp\) and
\(B\tpose\) are right semi-orthogonal, it is easy to show that \(\mathbf{B}\) is
orthogonal.
\begin{proof}
\[
    \mathbf{B}\mathbf{B}\tpose = 
    \begin{bmatrix}
        B^\perp (B^\perp)\tpose & B^\perp B \\
        (B^\perp B)\tpose & B\tpose B
    \end{bmatrix} = \Id{n}
    .
\]
Hence, \(\mathbf{B}\) is invertible with \(\mathbf{B}\inv = \mathbf{B}\tpose\).
\end{proof}

The following theorem shows that \(\mathbf{B}\) provides a canonical
transformation into simply actuated coordinates, so that only the actuated momenta
are affected by the input forces.

\begin{thm}\label{thm:simply-actuated}
    Under Assumptions \ref{assm:B-const},\ref{assm:B-perp}, and
    \ref{assm:B-orthogonal}, the Hamiltonian system ~\eqref{eqn:hamiltonian}
    has simply actuated canonical coordinates 
    \(\left(Q = \mathbf{B}q, P = \mathbf{B}p\right)\). The resulting dynamics are 
    given by ~\eqref{eqn:simple-hamiltonian},
    \begin{align}\label{eqn:simple-hamiltonian}
        \mathcal{H}(Q,P) &= 
        \frac{1}{2} P\tpose \Minv(Q) P + V(Q)
        , \\
       &\begin{cases}
            \dot{Q} = \Minv(Q)P \\
            \dot{P} = -\frac{1}{2} (\Id{n} \otimes P\tpose) \nabla_Q \Minv(Q) P
                - \nabla_Q V(Q) + \simpleB \tau
            ,
        \end{cases} \nonumber
    \end{align}
    where
    \begin{align*}
        \Minv(Q) &:= \mathbf{B}D^{-1}(\mathbf{B}\tpose Q)\mathbf{B}\tpose
        , \\
        V(Q) &:= P(\mathbf{B}\tpose Q)
        .
    \end{align*}
\end{thm}
\begin{proof}
    The change of coordinates \((Q = \mathbf{B}q, P = \mathbf{B}p)\)
    satisfies Lemma \ref{lemma:linear-is-canonical}, making it a canonical
    transformation.
    Furthermore, since \(\dot{P} = \mathbf{B}\dot{p}\), the new input matrix is
    given by 
    \[
        \mathbf{B}B = \begin{bmatrix}
            B^\perp B \\
            B\tpose B \\
        \end{bmatrix} = 
        \begin{bmatrix}
            \Zmat{(n-k)\times k} \\
            \Id{k}
        \end{bmatrix}
        ,
    \]
    which means \(\left(Q = (q_u,q_a), P = (p_u,p_a)\right)\) are simply
    actuated coordinates for \(\mathcal{H}\) as desired.
\end{proof}

\section{Virtual Nonholonomic Constraints}
% Motivation for VNHCs, they are an extension of VHCs, etc.
Let us imagine a child on a swing who wants to reach the largest height
possible. 
To begin, the child pushes off the ground to imbue the swing with small oscillations.
What allows them to increase the amplitude of these oscillations is the
appropriate extension and retraction of their feet.
If a roboticist were creating a machine to replicate this behaviour, they might
design a robot whose legs extend and retract at specific time intervals. 
At first glance, this technique should work perfectly because the leg motion
would synchronize with the swinging frequency, thereby injecting energy as
quickly as is physically possible.

Unfortunately, a deeper analysis reveals the flaw with this design.
Most children are not counting out the time in their head; rather, they observe
their current position and velocity and adjust their legs as required. 
For example, many children have an adult pushing the swing, or perhaps
they are swinging on a windy day. In either case, they adjust their leg
motion accordingly when presented with these external disturbances, without
keeping track of time. 
Hence, the standard control technique of tracking a function of time (known as
\textit{trajectory tracking}) does not truly replicate human behaviour.
Even if the robot's legs perfectly track a specified trajectory, 
an external disturbance will desynchronize the leg motion
with the swing - thereby stopping the amplitude-increasing effects.

%As has been observed in the field of mobile robotics, a trajectory tracking
%controller which has lagged behind due to a disturbance will do whatever is
%required to ``catch up" to the trajectory. 
%This can cause major safety issues, which is why many mobile roboticists prefer to
%design controllers which drive a vehicle along a gemoetric path in space rather than a
%trajectory in time.

%This path tracking approach has been extended to biologically-inspired robotics
%in a method known as \textit{virtual holonomic constraints} (VHCs).
Rather than tracking a trajectory over time, a more human-like behaviour 
is to force the robot's legs track a function of the swing's state. 
One recent control method known as \textit{virtual holonomic constraints} (VHCs)
uses the actuators to enforce a relation \(h(q) = 0\) of the configuration
\cite{vhcs_for_el_systems}. 
This method has provided incredible results in the development of 
walking robots \cite{vhc_robotic_walking, vhc_stable_walking}, 
vehicle motion \cite{vhc_bicycle, vhc_helicopter}, 
and has even been used to design a snake-like swimming robot
\cite{vhc_snake}.

The downside to VHCs is that they only depend on the configuration of a
mechanical system, and not its generalized velocity.
For the child on a swing, whether they extend or retract their legs
depends on their direction of motion. 
This inherently requires knowledge of their current velocity, which precludes
the usage of VHCs. 
A few authors have attempted to extend the theory of VHCs to enforce relations
\(h(q,\dot{q}) = 0\) of the full state to account for this drawback. 
Since these relations use actuators to restrict both the configuration and
velocity of a system, they are called virtual \textit{nonholonomic} constraints.
This idea has been used for human-robot interaction
\cite{vnhc_human_robot_cooperation,psd_based_vnhc_redundant_manipulator,haptic_vnhc},
error-reduction on time-delayed systems \cite{vnhc_time_delay_teleop},
and has shown marked improvements to the field of bipedal locomotion 
\cite{nhvc_dynamic_walking,
hybrid_zero_dynamics_bipedal_nhvcs,output_nhvc_bipedal_control}.
Most interestingly, this nonholonomic approach is more robust
than standard VHCs when applied to bipedal robotics \cite{nhvc_incline_walking}.
In particular, virtual nonholonomic constraints may be capable of injecting and
dissipating energy from a system in a robust manner, all while producing
realistic biological motion. This is what we aim to prove in this thesis.

Unlike the theory of VHCs, there does not appear to be a standard definition of
virtual nonholonomic constraints: 
all the applications listed above use their own definitions, which makes it
difficult to compare and generalize their work. 

This section will provide a standard characterization of virtual nonholonomic
constraints using Hamiltonian mechanics. 
The goal is to provide a consistent, rigorous foundation for designing
constraints on a general class of systems.

% Perform the full development of VNHCs, including its stabilizing
% controller.
\begin{defn}
    A \textit{virtual nonholonomic constraint} (VNHC) \textit{of order \(k\)} is a
    relation \(h(q,p) = 0\) where \(h : \mathcal{Q}\times\R^n \rightarrow \R^k\) is
    \(C^2\), \(\rank{\left[ dh_q,\, dh_p \right]} = k\) for all 
    \((q,p) \in h\inv(0)\), and there exists a feedback controller \(\tau(q,p)\)
    rendering the \textit{constraint manifold} \(\Gamma\) invariant
    where
    \[
        \Gamma = \left\{(q,p) \mid h(q,p) = 0, dh_q \dot{q} + dh_p \dot{p} = 0\right\}
        .
    \]
\end{defn}

From the definition of VNHCs, one finds that the constraint manifold \(\Gamma\)
is a \(2(n-k)\)-dimensional closed embedded submanifold of \(\mathcal{Q} \times \R^n\). 
The next obvious question is the following: when does a feedback controller
stabilizing \(\Gamma\) exist?

One approach to answering this question is to
define the error term \(e = h(q,p)\). 
If there exists some controller \(\tau(q,p)\) driving \(e \to 0\) and 
\(\dot{e} \to 0\), then the same \(\tau\) will necessarily stabilize \(\Gamma\)
(under additional mild conditions, see \cite{vhcs_for_el_systems})
\footnote{The type of constraints we consider in this thesis are graphs of
functions, and so meet these mild assumptions.}.

We say that \(e\) is of \textit{relative degree} \(\{r_1,\ldots,r_k\}\) if
\begin{enumerate}
    \item Some component of \(\tau\) appears at the \(r_i^\text{th}\) derivative
        of \(e_i\) for \(i \in \{1,\ldots,k\}\).
    \item In the vector of time-derivatives
        \((e_1^{(r_1)}, \ldots, e_k^{(r_k)})\), the vector \(\tau\) is
        premultiplied by a nonsingular matrix.
\end{enumerate}
With no further structure on \(h(q,p)\), the control input \(\tau\) usually
appears after one derivative of \(e\); 
unfortunately, if any \(e_i\) has relative degree \(r_i = 1\) we may not
be able to stabilize \(\Gamma\). 
We could guarantee \(e_i(t) \to 0\), but we could not in general guarantee 
\(\dot{e}_i(t) \to 0\). 

Requiring \(e\) to have relative degree \(\{2,\ldots,2\}\) is much more
useful, since it allows us to easily solve for a controller stabilizing \(\Gamma\).
This kind of relative degree requirement is already common in the VHC
literature.
Taking advantage of that precedent, we define a special type of VNHC that
satisfies this property.

\begin{defn}
    A VNHC \(h(q,p) = 0\) of order \(k\) is \textit{regular} if the output 
    \(e = h(q,p)\) is of relative degree \(\{2,2.\ldots,2\}\) everywhere on the
    constraint manifold \(\Gamma\).
\end{defn}

The authors of
\cite{nhvc_dynamic_walking,hybrid_zero_dynamics_bipedal_nhvcs,nhvc_incline_walking}
observed that a relation which uses only the unactuated conjugate of momentum
cannot have \(\tau\) appearing after only one derivative. Of course,
they performed their research in Lagrangian form; we will be using
the Hamiltonian formulation from Chapter \ref{sec:simply-actuated}.
As a reminder, our system is described in \((q,p)\) coordinates with 
\(q = (q_u,q_a)\) and \(p = (p_u, p_a)\) and has the dynamics
\begin{align}\label{eqn:simply-actuated-hamiltonian}
    \mathcal{H}(q,p) &= p\tpose \Minv(q) p + V(q)
    , \\
    \label{eqn:simply-actuated-dynamics}
    &\begin{cases}
       \dot{q} = \Minv p \\
       \dot{p} = -\frac{1}{2} \pdmat - \nabla_q V(q) + \simpleB \tau 
       .\\
    \end{cases}
\end{align}

\begin{notation}
    We will write \(q_u \in \mathcal{Q}_u\), \(q_a \in \mathcal{Q}_a\) where
    \(\mathcal{Q}_u \times \mathcal{Q}_a = \mathcal{Q}\). 
    We also write
    \(p_u \in \mathcal{P}_u := \R^{n-k}\) and 
    \(p_a \in \mathcal{P}_a := \R^k\), so that 
    \(p \in \mathcal{P} := \mathcal{P}_u \times \mathcal{P}_a = \R^n\). 
    In this manner, the phase space of our system can be written as
    \(\mathcal{Q} \times \mathcal{P}\).
\end{notation}

\begin{thm}\label{thm:vnhc-regularity}
    A relation \(h(q,p) = 0\) for system ~\eqref{eqn:simply-actuated-hamiltonian}
    is a regular VNHC of order \(k\) if and only if \(dh_{p_a} = 0\) 
    and
    \[
        \rank{\left(dh_q \Minv(q) - 
          dh_{p_u} (\Id{n-k} \otimes p\tpose)\nabla_{q_u}\Minv(q) 
         \right)\simpleB} = k
         ,
    \]
    everywhere on the constraint manifold \(\Gamma\).
\end{thm}
\begin{proof}
    Let \(e = h(q,p) \in \R^k\). Then 
    \begin{align*}
        \dot{e} &= dh_q \dot{q} + dh_p \dot{p} \\
                &= dh_q \Minv(q)p +{}  \\
            & \begin{bmatrix} dh_{p_u} & dh_{p_a} \end{bmatrix}
        \left( -\frac{1}{2} \begin{bmatrix}
            (\Id{n-k} \otimes p\tpose) \nabla_{q_u}\Minv(q)p \\
            (\Id{k} \otimes p\tpose) \nabla_{q_a}\Minv(q)p
            \end{bmatrix} - \begin{bmatrix}
            \nabla_{q_u}V(q) \\
            \nabla_{q_a}V(q)
        \end{bmatrix} + \simpleB \tau\right)
        .
    \end{align*}
    If \(dh_{p_a} \neq \Zmat{k \times k}\) for some \((q,p)\) on \(\Gamma\), 
    then \(\tau\) appears in \(\dot{e}\) and the VNHC is not of relative degree
    \(\{2,2,\ldots,2\}\).
    Hence, we must have that \(dh_{p_a} = \Zmat{k \times k}\).
    Proceeding with this assumption, we now find that
    \(h : \mathcal{Q} \times \mathcal{P}_u \rightarrow \R^k\), which means that
    \[
        \dot{e} = dh_q \Minv(q)p - 
        dh_{p_u} \left(\frac{1}{2} \pudmat + \nabla_{q_u}V(q)\right)
        .
    \]
    Taking one further derivative provides
    \begin{align*}
        \ddot{e} &= \left(\diff{}{t}dh_q\right)\Minv(q) p + 
        dh_q \left(\sum\limits_{i=1}^n \pdiff{\Minv}{q_i}(q)\dot{q_i}\right)p + 
        dh_q \Minv(q) \dot{p} - \\
         & \left(\diff{}{t}dh_{p_u}\right)
         \left(\frac{1}{2}\pudmat + \nabla_{q_u}V(q)\right) - \\
         & dh_{p_u}\left(\frac{1}{2}\diff{}{t}\left(\pudmat\right) + 
         \left(\diff{}{t}\nabla_{q_u}V(q)\right) \right)
         .
    \end{align*}
    Most of these terms do not involve \(\dot{p}\) and hence do not contain 
    \(\tau\), so we shorten this to 
    \[
        \ddot{e} = (\star) - 
        dh_{p_u}\left(\frac{1}{2}\diff{}{t}\left(\pudmat\right)\right) +
        dh_q \Minv(q) \simpleB \tau
        .
    \]
% d/dt(1/2 * pudmat)
    Observe that the \(i^\text{th}\) row of
    \(\frac{1}{2} \diff{}{t} \left( \pudmat \right)\)
    is given by
    \begin{align*}
        \frac{1}{2} \diff{}{t}\left(p\tpose \pdiff{\Minv}{q_{u_i}}(q)p\right)
        = p\tpose \pdiff{\Minv}{q_{u_i}}(q) \dot{p} + 
        \frac{1}{2} p\tpose \left( \sum_{j=1}^n \ppdiff{\Minv}{q_{u_i}}{q_j}
        \dot{q}_j \right) p
        .
    \end{align*}
    Highlighting only the term containing \(\tau\), we get the vector form
    \begin{align*}
        \frac{1}{2} \diff{}{t} \left( \pudmat \right) =
        (\star) +
        (\Id{n-k} \otimes p\tpose)\nabla_{q_u}\Minv(q)\simpleB \tau
        .
    \end{align*}
% Full ddot(e)
    Plugging this into \(\ddot{e}\) reveals that
    \begin{align*}
        \ddot{e} = (\star) +
     \left(dh_q \Minv(q) - dh_{p_u}(\Id{n-k} \otimes
     p\tpose)\nabla_{q_u}\Minv(q) \right) \simpleB \tau
     ,
    \end{align*}
    where \((\star)\) is a continuous function of \(q\) and \(p\).
% End of Proof
    For shorthand, we'll write 
    \[
        \ddot{e} = E(q,p) + H(q,p)\tau
        ,
    \] 
    where \(E\) and \(H\) are defined appropriately.
    From the definition of regularity, the VNHC \(h\) is regular 
    when \(e\) is of relative degree \(\{2,\ldots,2\}\), which is true 
    if and only if the matrix premultiplying \(\tau\) is nonsingular, and hence
    that \(H\) is invertible. This proves the theorem.
\end{proof}

Using the expression \(\ddot{e} = E(q,p) + H(q,p)\tau\) from the proof of 
Theorem \ref{thm:vnhc-regularity}, a regular VNHC of order \(k\) can be
stabilized by\footnote{Under additional mild conditions
\cite{vhcs_for_el_systems}} the output-linearizing phase-feedback controller
\begin{equation}\label{eqn:vnhc-torque-controller}
    \tau(q,p) = -H\inv(q,p)\left(E(q,p) + k_p e + k_d \dot{e}\right)
    ,
\end{equation}
where \(k_p, k_d \in \R_{>0}\) are control parameters which can be tuned on the
resulting linear system \(\ddot{e} = -k_p e - k_d\dot{e}\). 

Note that one generally cannot measure conjugate of momenta directly, as sensors
on mechanical systems will only measure the state \((q,\dot{q})\). To
implement this controller in practice, one must compute \(p = M(q)\dot{q}\) at
every iteration. In other words, this controller requires knowledge of the full
state of the system.

% Special case: when dM/dqu = 0, show that we have a nice form and that we
%can solve for p_a and the closed-loop dynamics (qu,pu)_dot

Now that we have found a controller to enforce a regular VNHC of order \(k\), we
would like to determine the dynamics on the constraint manifold \(\Gamma\). 
Intuitively, these dynamics should be parameterized by \((q_u, p_u)\) since
\(q_a\) is a function of these as specified by \(h(q,p_u) = 0\).
Unfortunately, \(\dot{q}_u\) depends on \(p_a\), and for general systems one
cannot solve explicitly for \(p_a\) in terms of \((q_u,p_u)\). 
This is because the \(\dot{p}\) dynamics contains the coupling term 
\((\Id{n} \otimes p\tpose)\nabla_{q_u}M(q)p\). 

We now introduce an assumption so we can solve explicitly for the constrained
dynamics.

\begin{assm}\label{assm:inertially-actuated}
    The Hamiltonian system has an inertia matrix that does not depend on the
    unactuated coordinates:
    \[
        \nabla_{q_u}M(q) = \Zmat{n(n-k) \times n}
        .
    \]
\end{assm}

\begin{thm}\label{thm:zero-dynamics}
    Let \(\mathcal{H}\) be a mechanical system in simply actuated
    coordinates satisfying Assumption \ref{assm:inertially-actuated}. 
    Let \(h(q,p_u) = 0\) be a regular VNHC of order \(k\) with constraint
    manifold \(\Gamma\). Suppose that on \(\Gamma\) one can solve for
    \(q_a\) as a function \(q_a = f(q_u,p_u)\).
    Then the constrained dynamics are given by
    \begin{equation}\label{eqn:qpu-dynamics}
        \left.\begin{aligned}
                \dot{q}_u &= \begin{bmatrix}
                    \Id{(n-k)} & \Zmat{(n-k) \times k}
                \end{bmatrix}\Minv(q)p \\
            \dot{p}_u &= -\nabla_{q_u}V(q) \\
            \end{aligned}{}\right|_{\begin{array}{c}
                q_a = f(q_u,p_u) \\ 
                p_a = g(q_u,p_u) \\
            \end{array}}
            ,
    \end{equation}
    where
    \begin{equation}\label{eqn:g-qpu}
    \begin{aligned}
        &g(q_u,p_u) := \\
           &\left.\left(dh_q \Minv(q) \simpleB \right)\inv 
        \left(dh_{p_u} \nabla_{q_u}V(q) - dh_q \Minv(q)
        \begin{bmatrix}
            I_{n-k} \\
            \Zmat{k \times (n-k)} \\
        \end{bmatrix} p_u\right)\right|_{q_a = f(q_u,p_u)}
        .
    \end{aligned}
    \end{equation}
\end{thm}
\begin{proof}
    Setting \(e = h(q,p_u)\) and using the fact that 
    \(\nabla_{q_u}\Minv(q) = 0\), we find that
    \[
        \dot{e} = dh_q\Minv(q)p - dh_{p_u}\nabla_{q_u}V(q)
        .
    \]
    Observe that
    \begin{align*}
        dh_q\Minv(q)p &= dh_q\Minv(q) \begin{bmatrix}p_u \\ p_a \end{bmatrix} \\
          &= dh_q\Minv(q) \begin{bmatrix}
              \Id{n-k} & \Zmat{(n-k)\times k} \\
              \Zmat{k \times(n-k)} & \Id{k} 
              \end{bmatrix} \begin{bmatrix} p_u \\ p_a \end{bmatrix} \\
        &= dh_q\Minv(q)\begin{bmatrix} \Id{n-k} \\ \Zmat{k \times
        (n-k)}\end{bmatrix} p_u + dh_q \Minv(q)\simpleB p_a
        .
    \end{align*}
    On the constraint manifold, we have \(e = \dot{e} = 0\), which means
    \[
        dh_q\Minv(q)\simpleB p_a = dh_{p_u}\nabla_{q_u}V(q) -
            dh_q\Minv(q)\begin{bmatrix} 
            \Id{n-k} \\ \Zmat{k \times (n-k)}\end{bmatrix} p_u
        .
    \]
    Since \(h\) is regular and \(\nabla_{q_u}\Minv(q) = 0\), we have that 
    \[
        \rank{dh_q\Minv(q)\simpleB} = k
        .
    \]
    Solving for \(p_a\) gives
    \[
        p_a(q,p_u) = \left(dh_q\Minv(q)\simpleB\right)\inv
        \left(dh_{p_u}\nabla_{q_u}V(q) - 
            dh_q\Minv(q)\begin{bmatrix} 
        \Id{n-k} \\ \Zmat{k \times (n-k)}\end{bmatrix} p_u \right)
        .
    \]
    This yields a function \(p_a(q,p_u)\). However, on \(\Gamma\) we have 
    \(q_a = f(q_u,p_u)\), which we use to solve for \(p_a = g(q_u,p_u)\). 
    Since \(q_a\) and \(p_a\) can be computed directly from \((q_u,p_u)\), the
    dynamics on \(\Gamma\) are parameterized only by \((\dot{q}_u,\dot{p}_u)\).
\end{proof}

Theorem \ref{thm:zero-dynamics} shows that, for a particular class of systems
and constraints, the dynamics on \(\Gamma\) are entirely described by the \(2(n-k)\)
unactuated coordinates.
This is true regardless of the number of degrees of freedom of the system.

The following corollay applies Theorem \ref{thm:zero-dynamics} to
systems with only one unactuated coordinate.

\begin{cor}\label{cor:2d-zero-dynamics}
    Let \(\mathcal{H}\) be the system ~\eqref{eqn:simple-hamiltonian} with degree
    of underactuation one.
    Suppose \(\mathcal{H}\) satisfies Assumption \ref{assm:inertially-actuated}.
    Let \(h(q,p_u) = 0\) be a regular VNHC of order \((n-1)\) of the form
    \(h(q,p_u) = q_a - f(q_u,p_u)\),
    where \(f\) is a suitably defined \(C^2\) function.
    Then \(dh_q = \begin{bmatrix} -\partial_{q_u}f & \Id{(n-1)}
    \end{bmatrix}\).
    Defining \(e_1 := (1,0,\ldots,0) \in \R^n\), the actuated momentum is
    \begin{equation}\label{eqn:g-qupu}
        p_a = -\left.\left(dh_q \Minv(q)
        \begin{bmatrix}
            \Zmat{1\times (n-1)}\\
            I_{(n-1)}
        \end{bmatrix}\right)\inv 
        \left(\partial_{p_u}f \partial_{q_u}V + dh_q \Minv(q)e_1 p_u\right) 
            \right|_{q_a =f(q_u,p_u)}
        .
    \end{equation}
    Since \(q_u \in \Rt{T_u}\) for some \(T_u \in ]0,\infty]\) and \(p_u \in \R\),
    the orbit \((q_u(t),p_u(t))\) traces out
    a curve on the 2D constraint manifold 
    \(\Gamma \simeq \Rt{T_u} \times \R\) which we call the \((q_u,p_u)\)-plane.
\end{cor}

We conclude this chapter by formalizing the notion of energy injection for
VNHCs.
To glean some intuition for this idea, suppose our mechanical system satisfies
the above corollary so that the constraint manifold \(\Gamma\) is the
\((q_u,p_u)\)-plane.
If any initial condition of the constrained dynamics converges to the origin, 
the system must be losing energy because the unactuated momentum
\(p_u\) is decreasing.
Any notion of energy injection must therefore require that the origin of 
\(\Gamma\) repels all solutions.
Furthermore, periodic solutions prevent the system from attaining higher speeds,
so the constrained dynamics should not have closed orbits or limit cycles.
Finally, we want the unactuated momentum to increase on average, regardless of
its initial value. 
This intuition is generalized to ODEs on manifolds by the following definition.

% TODO: Change this, 0 is not an element of the manifold. Do we need other
% notions, like a riemannian metric? Should we just use Gamma?
\begin{defn}\label{defn:energy-gain}
    Let \(\mathcal{Q}\) be an
    \(n\)-dimensional generalized cylinder.
    Let \(f : \mathcal{Q} \rightarrow \mathcal{Q}\times\R^n\) be a smoth vector
    field and let \(D \subset M\) be open.
    The system described by \(\dot{x} = f(x)\) 
    \textit{gains energy on \(D\)} if, 
    for all compact sets \(K \subset D\) and for almost every initial
    condition \(x(0) \in K\), there exists \(T > 0\) such
    that \(x(t) \notin K \, (\forall t > T)\).
    The system \textit{loses energy on \(D\)} if it gains energy in
    negative-time.
\end{defn}

Any system satisfying Definition \ref{defn:energy-gain}
can have unstable equilibria on \(D\), but not limit cycles nor closed orbits.
The next definition ties this notion of energy gain to VNHCs.

\begin{defn}\label{defn:energy-injection}
    A regular VNHC \(h(q, p) = 0\) with constraint manifold \(\Gamma\)
    \textit{injects (dissipates) energy on \(D \subset \Gamma\)} if the
    constrained dynamics gain (lose) energy everywhere on \(D\), except possibly
    on a set of measure zero.
\end{defn}

\section{Summary of Results}
In this chapter, we developed the framework of virtual nonholonomic constraints
for underactuated Hamiltonian mechanical systems.
We made the following assumptions:
\begin{enumerate}
    \item The input matrix \(B(q) \equiv B \in \R^{n \times k}\) is constant and
        full rank.
    \item The input matrix has a left-annihilator 
        \(B^\perp \in \R^{(n-k)\times n}\). 
    \item The annihilator matrix \(B^\perp\) is right semi-orthogonal.
\end{enumerate}
These assumptions allowed us to define a canonical change of coordinates
into the simply actuated coordinates 
\((q,p) \in \mathcal{Q} \times \mathcal{P}\),
where \(q = (q_u,q_a)\) and \(p = (p_u,p_a)\).

We defined a virtual nonholonomic
constraint as a function 
\(h \in C^2(\mathcal{Q}\times\mathcal{P}; \R^k)\) 
which has no singular points on its constraint manifold
\[
    \Gamma = \left\{(q,p) \mid h(q,p) = 0, dh_q \dot{q} + dh_p \dot{p} = 0\right\}
    .
\]

We then showed that a VNHC 
\(h : \mathcal{Q} \times \mathcal{P}_u \rightarrow \R^k\) is regular if and only
if the square matrix
\[
    \left(
    dh_q \Minv(q) - 
    dh_{p_u} (\Id{n-k} \otimes p\tpose)\nabla_{q_u}\Minv(q) 
    \right)
    \simpleB
\]
is invertible on \(\Gamma\).

To find the explicit equations for constrained dynamics of a regular VNHC, 
we made the following assumptions:
\begin{itemize}
    \item The inertia matrix satisfies 
        \(\nabla_{q_u}M(q) = \Zmat{n(n-k) \times n}\).
    \item On \(\Gamma\), one can solve for \(q_a\) as a function of
        \((q_u,p_u)\).
\end{itemize}
If these assumptions hold, one can solve for \(p_a = g(q_u,p_u)\) on \(\Gamma\).
The constrained dynamics are then given by
\((\dot{q_u}, \dot{p_u})\) subject to \(h(q,p_u) = 0\) and \(p_a = g(q_u,p_u)\).

Finally, we saw the benefit of using VNHCs is that they reduce the
dimensionality of the system from \(2n\) equations of motion to \(2(n-k)\)
equations, which significantly reduces the complexity of analyzing large systems.
In particular, if the system has degree of underactuation one, the dynamics
reduce to a \(2\)D system on the ``\((q,p)\)-plane" \(\Rt{T}\times\R\).

%%/========== /Virtual Nonholonomic Constraints ==========/% 
% vim: set tw=80 ts=4 sw=4 sts=0 et ffs=unix :
