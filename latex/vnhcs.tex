%/===============/%
\section{Virtual Nonholonomic Constraints}

%/----- Motivation -----/%
\subsection{Motivation}
TODO: Why do we bother with Hamiltonian? Why can't we do virtual nonholonomic constraints in Lagrangian?

%/----- Lagrange vs Hamilton -----/%
\subsection{A Hamiltonian Approach to Virtual Nonholonomic Constraints}
Take an underactuated mechanical system 
\begin{equation}\label{eqn:eom_lagrangian}
M(q)\ddot{q} + C(q,\dot{q})\dot{q} + \nabla V(q) = B(q)\tau
\end{equation}
with Lagrangian
\begin{equation}\label{eqn:lagrangian}
\mathcal{L}(q,\dot{q}) = \frac{1}{2} \dot{q}^T M(q) \dot{q} - V(q)
\end{equation}
where \(q = (q_1,\ldots,q_n) \in \mathcal{Q}\) is the configuration vector, the inertia matrix \(M(q) = M^T(q)\) is positive definite for all \(q \in \mathcal{Q}\), \(V(q)\) is the potential of the system, \(B : \mathcal{Q} \rightarrow \mathbb{R}^{n \times m}\) is a \(C^1\) full rank control matrix, and \(\tau \in \mathbb{R}^{m}\) is the control input.

One can compute the Hamiltonian of this system by performing a Legendre transform on the Lagrangian. Define the conjugate of momenta for \(q\) by 
\[
p = \frac{\delta \mathcal{L}}{\delta \dot{q}} \in \mathbb{R}^n
\]
Then, the Legendre transform is performed by taking
\[
\mathcal{H}(q,p) = p^T \dot{q} - \mathcal{L}(q,\dot{q})
\]
It is easy to verify that the Hamiltonian for system (\ref{eqn:lagrangian}) is given by the total mechanical energy (\ref{eqn:hamiltonian}).
\begin{equation}\label{eqn:hamiltonian}
\mathcal{H}(q,p) = E(q,p) = \frac{1}{2} p^T M^{-1}(q) p + V(q)
\end{equation}

The equations of motion for the system in Hamiltonian coordinates is given by
\begin{align}\label{eqn:hamiltionian_eom}
\begin{split}
\dot{q} &= \frac{\delta \mathcal{H}}{\delta p} = M^{-1}(q) p \\
\dot{p} &= -\frac{\delta \mathcal{H}}{\delta q} + B \tau
\end{split}
\end{align}

Suppose the mechanical system has degree of underactuation one, so that coordinates of the system can be split into an unactuated component \(q_u \in [\mathbb{R}]_T, \, T \in \mathbb{R}_{>0}\) which is not influence by control, along with an actuated component \(q_a\); that is, suppose \(B\) is of the form \(B(q) = [0_m, B_1^T(q), \ldots, B_n^T(q)]^T, \, B_i^T(q) \in \mathbb{R}^{n-1}\) and \(\tau \in \mathbb{R}^{n-1}\). In this case, \(q = (q_u, q_a)^T\) and the equations of motion become
\begin{align}\label{eqn:unactuated_actuated_eom}
\begin{split}
\dot{q_u} &= e_1^T M^{-1}(q) p \\
\dot{p_u} &= -p^T\frac{\delta M}{\delta q_u} p - \delta_{q_u}V(q) \\
\dot{q_a} &= 
\begin{bmatrix}
0 \cdots 0 \\
I_{n-1} \\
\end{bmatrix} M^{-1}(q) p \\
\dot{p_a} &= -p^T\frac{\delta M}{\delta q_a} p - \nabla{q_a}V(q) + 
\begin{bmatrix}
B_1(q) \\
\vdots \\
B_n(q)
\end{bmatrix} \tau
\end{split}
\end{align}

Now we can begin to talk about Virtual Nonholonomic Constraints. In a similar fashion to what was defined for VHCs, let us first define the goal of these new virtual constraints.

\begin{defn}
A relation \(h \in C^2\left(\mathcal{Q}\times \mathbb{R}^n ; \mathbb{R}^k\right)\) with \(h(q,p) = 0\) is a \textbf{virtual nonholonomic constraint (VNHC) of order k} if there exists a feedback control \(\tau(q,p)\) which stabilizes the constraint manifold
\[
\Gamma = \left\{(q,p) | h(q,p) = 0, dh_q \dot{q} + dh_p \dot{p} = 0\right\}
\]
\end{defn}
Define the output of the system to be \(e = h(q,p)\). We would like to find \(\tau(q,p)\) which drives \(e\) to zero to stabilize our constraint manifold \(\Gamma\). To accomplish this, we will input-output linearize (\ref{eqn:unactuated_actuated_eom}) to find \(\ddot{e} = -k_p e - k_d \dot{e}\) with \(k_p, k_d \in \mathbb{R}_{> 0}\).

To characterize a certain class of VNHCs, let us make the following assumption.
\begin{assm}\label{assm:vnhc_is_on_qu_pu}
We assume our relation \(h\) is of the form \(h(q,p) = q_a - f(q_u,p_u)\) for some \(f \in C^2\left([\mathbb{R}]_T \times \mathbb{R} ; \mathbb{R}^{n - 1}\right)\).
\end{assm}

Now we solve for \(\tau\) by finding \(\ddot{e}\).
\begin{align*}
    e &= h(q,p) = qa - f(q_u,p_u)\\
    \Rightarrow \dot{e} &= \dot{q_a} - df_{q_u}\dot{q_u} -df_{p_u}\dot{p_u} \\
    &= [-df_{q_u} I_{n-1}]\dot{q} - df_{p_u} \dot{p_u} \\
    &= dh_q M^{-1}(q) p - df_{p_u}\left( -\frac{1}{2}p^T \frac{\delta M^{-1}(q)}{\delta q_u} p - \delta_{q_u}V(q) \right) \\
    &= dh_q M^{-1}(q) p + \frac{1}{2}df_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u} p + df_{p_u}\delta_{q_u}V(q)
\end{align*}
The control input \(\tau\) only appears in \(\dot{p_a}\) (see (\ref{eqn:unactuated_actuated_eom})). To simplify the analysis, terms in \(\ddot{e}\) which do not depend on \(\dot{p_a}\) explicitly are lumped together under the symbol \((*)\):
\begin{align*}
    \ddot{e} &= dh_q M^{-1}(q) \dot{p} + df_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u} \dot{p} + (*) \\
    &= (dh_q M^{-1}(q) + df_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u})B\tau + (*) \\
    &= (dh_q M^{-1}(q) + dh_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u})B\tau + (*)
\end{align*}

From the derivations above, one can solve for \(\tau\) iff the matrix on the left of \(\tau\) is full rank. Thus, for systems with degree of underactuation one we give the following definition.
\begin{defn}
A VNHC \(h(q,p) = 0\) of order \(n - 1\) is \textbf{regular} if \(dh_{p_a} = 0\), \(dh_{q_a} = (1 \ldots 1)^T\), and 
\[
\text{rank}\left\{ (dh_q M^{-1}(q) + dh_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u})B\right\} = n - 1
\]
everywhere on the constraint manifold \(\Gamma\). Equivalently, a VNHC \(h\) of order \(n - 1\) is regular if it satisfies Assumption \ref{assm:vnhc_is_on_qu_pu} and system (\ref{eqn:unactuated_actuated_eom}) with output \(e = h(q,p)\) is of relative degree \(\{2,2,\ldots,2\}\) everywhere on \(\Gamma\).
\end{defn}

In general, \(\dot{e}\) is a function of \(q_u\) and \(p = (p_u,p_a)^T\). Since the purpose of a regular VNHC is to fully parameterize \(\Gamma\) by \((q_u,p_u)\), it is essential that one can solve for \(p_a = p_a(q_u,p_u)\). Unfortunately this often cannot be done, since \(\dot{e}\) contains the quadratic term
\[
\frac{1}{2} df_{p_u} p^T \frac{\delta M^{-1}(q)}{\delta q_u} p 
\]
We can solve for \(p_a\) if this quadratic term does not exist.
\begin{assm}\label{assm:M_is_Mqa}
Assume \(\delta M(q) / \delta q_u = 0 \Leftrightarrow \delta M^{-1}(q) / \delta q_u = 0\)
\end{assm}

Under Assumption \ref{assm:M_is_Mqa}, we get that the rank condition for \(h(q,p)\) to be a regular VNHC reduces to \(\text{rank}\left(dh_q M^{-1} B\right) = n - 1\). This is the same rank condition as required for Virtual Holonomic Constraints.

Now we solve for \(p_a\) on the constraint manifold (when \(e = \dot{e} = 0\)):
\begin{align*}
    \dot{e} = dh_q M^{-1}(q)p + df_{p_u} \delta_{q_u}V(q) &= 0\\
    \Leftrightarrow dh_q M^{-1}(q)e_1 p_u + dh_q M^{-1}(q) \begin{bmatrix}
    0 & \cdots & 0 \\
    & I_{n-1} & \\
    \end{bmatrix} p_a &= -df_{p_u} \delta_{q_u}V(q) \\
\end{align*}
\begin{align*}
    \Leftrightarrow dh_q M^{-1}(q) \begin{bmatrix}
    0 & \cdots & 0 \\
    & I_{n-1} & \\
    \end{bmatrix} p_a = -\left(df_{p_u}\delta_{q_u}V(q) + dh_q M^{-1}(q)e_1 p_u\right)
\end{align*}
One can linearly solve for \(p_a\) if and only if the matrix in front of it is invertible.

This leads us to a natural definition.
\begin{defn}\label{defn:solvability}
A VNHC \(h(q,p)\) is \textbf{solvable} (NOTE: actionable? what's a good name?) if
\[
\text{rank}\left(dh_q M^{-1}(q) \begin{bmatrix}
    0 & \cdots & 0 \\
    & I_{n-1} & \\
    \end{bmatrix}\right) = n - 1
\]
\end{defn}

With this analysis and our new definition in hand, we can solve for the dynamics on the constraint manifold.

\begin{thm}\label{thm:equation_for_pa}
Suppose assumptions \ref{assm:vnhc_is_on_qu_pu} and \ref{assm:M_is_Mqa} hold. If a regular VNHC \(h(q,p) = q_a - f(q_u,p_u)\) is solvable, then the parameterization for \(p_a\) on the constraint manifold is given by
\begin{align*}
p_a &= -\left(dh_q M^{-1}(q) \begin{bmatrix}
    0 & \cdots & 0 \\
    & I_{n-1} & \\
    \end{bmatrix}\right)^{-1}\left( df_{p_u}\delta_{q_u}V(q) + dh_q M^{-1}(q)e_1 p_u\right) \\
    &=: g(q_u,p_u)
\end{align*}
and the constrained dynamics on \(\Gamma\) are given by
\begin{align*}
    \dot{q_u} &= e_1^T M^{-1}(q_a) \begin{bmatrix}
    p_u \\
    p_a
    \end{bmatrix}\mid_{q_a = f(q_u,p_u), p_a = g(q_u,p_u)} \\
    \dot{p_u} &= -\delta_{q_u} V(q_u,q_a) \mid_{q_a = f(q_u,p_u)}
\end{align*}
\end{thm}

Theorem \ref{thm:equation_for_pa} guarantees that, on \(\Gamma\), \(q_a\) is a parameterized completely by \((q_u,p_u)\). Hence, the zero-dynamics on \(\Gamma\) are always two-dimensional regardless of the original dimension \(n\).
%/===============/%