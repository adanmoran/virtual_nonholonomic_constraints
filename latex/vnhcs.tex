%! TEX root = main.tex

%/========== Virtual Nonholonomic Constraints ==========/%

\chapter{Development of Virtual Nonholonomic Constraints}
% TODO: Brief introduction before preliminaries

\section{Preliminaries on Analytical Mechanics}
A mechanical system can be represented by \(N\) point masses where each point
represents the center of mass of a physical body, along with \(r\)
\textit{equations of constraint} (EOC) which model the physical restrictions
between these masses.
The position of each point mass is described using three cartesian coordinates (one
for each spatial axis), so the system as a whole can be described by a vector in
\(\R^{3N}\) with \(r\) EOC. 
The dynamics of the system are computed by deriving the \(3N\)
\textit{equations of motion} (EOM) produced by Newton's second law \(F = m a\).
While this technique works for simple systems, it is impossible to
apply to a majority of mechanical systems since most of the forces 
on the system are not explicitly known. 

Rather than modeling a mechanical system with point masses and constraints,
it is often feasible to represent the position of the system using \(n\)
independent scalar-valued variables \(q_1,\ldots,q_n\) called 
\textit{generalized coordinates}, where \(n = 3N - r\) is the number of
\textit{degrees of freedom} (DOF) of the system \cite{greenwood_dynamics}.

For the robotic systems of interest in this thesis, we assume that
each generalized coordinate \(q_i\) represents either the distance or the angle
between two parts of the system.
Mathematically, each \(q_i\) takes values in \(\Rt{T_i}\), where
\(T_i = \infty\) if \(q_i\) represents a length or \(T_i = 2\pi\) if \(q_i\)
represents an angle.
It is convention to collect the coordinates into a \textit{configuration} 
\(q = (q_1,\ldots,q_n) \in \mathcal{Q}\) 
where the \textit{configuration manifold} \(\mathcal{Q}\) of the system is a
so-called \textit{generalized cylinder}:
\[
    \mathcal{Q} = \Rt{T_1} \times \cdot \times \Rt{T_n}
\] 
The derivative \(\dot{q} = (\dot{q}_1,\ldots,\dot{q}_n)\) of a configuration
is called a \textit{generalized velocity} of the system. For arbitrary systems,
the space of allowable velocities depends on the current configuration of the
system.  However, since \(\mathcal{Q}\) is a generalized cylinder, we find that 
\(\dot{q} \in \R^n\).
The combined vector \((q,\dot{q}) \in \mathcal{Q}\times\R^n\) is called a 
\textit{state} of the system.

The field of analytical mechanics provides a computational method for finding
the EOM of a system in generalized coordinates. The two most common analytical
methods for modelling robotic systems are \textit{Lagrangian} and
\textit{Hamiltonian} mechanics.

% ---------- Lagrangian Mechanics ---------- % 
\subsection{Lagrangian Mechanics}

Lagrangian mechanics uses the kinetic energy \(T(q,\dot{q})\) and potential
energy \(P(q)\) of the system to define the Lagrangian 
\(\mathcal{L} : \mathcal{Q}\times\R^n \rightarrow \R\) defined by
(\ref{eqn:lagrangian-general}) \cite{greenwood_dynamics}.
\begin{equation}\label{eqn:lagrangian-general}
    \mathcal{L}(q,\dot{q}) = T(q,\dot{q}) - P(q)
\end{equation}
When the mechanical system is actuated, the EOM are described by \(n\) second-order
ordinary differential equations (ODEs) obtained from the \textit{Euler-Lagrange
equations} with \textit{generalized input forces} \(\tau \in \R^k\) 
(\ref{eqn:el-eqns-general}). 
\begin{equation}\label{eqn:el-eqns-general}
    \diff{}{t}\left\{ \pdiff{\mathcal{L}}{\dot{q}_i} \right\}
    - \pdiff{\mathcal{L}}{q_i} = B_i\tpose(q) \tau
\end{equation}
The vector \(B_i\tpose: \mathcal{Q} \rightarrow \R^{1\times k}\) describes how
the input forces shape the dynamics of \(q_i\).
The matrix  \(B: \mathcal{Q} \rightarrow \R^{n \times k}\) with
\[
    B(q) = \begin{bmatrix}
        - & B_1\tpose(q) & - \\
          & \vdots & \\
        - & B_n\tpose(q) & - \\
    \end{bmatrix}
\]
is called the \textit{input matrix} for the system.
If \(k < n\), we say the system is \textit{underactuated} with degree of
underactuation \(n - k\).

Many actuated mechanical systems have quadratic kinetic energies, so that the
Lagrangian can be written explicitly as
\begin{equation}\label{eqn:lagrangian}
    \mathcal{L}(q,\dot{q}) = \frac{1}{2} \dot{q}\tpose D(q) \dot{q} - P(q)
\end{equation}
where the \textit{inertia matrix} \(D: \mathcal{Q} \rightarrow \R^{n\times n}\) 
is a symmetric, positive definite matrix for all \(q \in \mathcal{Q}\) and the
potential function \(P : \mathcal{Q} \rightarrow \R\) is smooth. 
%If this is the case, the Euler-Lagrange equations reduce to (\ref{eqn:el-eqns}),
%\begin{equation}\label{eqn:el-eqns}
%    D(q)\ddot{q} + C(q,\dot{q})\dot{q} + \nabla P(q) = B(q)\tau
%\end{equation}
%where the \textit{Coriolis matrix} \(C(q,\dot{q})\) is of the form
%\[
%    [C]_{i,j} = \frac{1}{2}\sum\limits_{k = 1}^n 
%    \left(\pdiff{D_{i,j}}{q_k}  +
%     \pdiff{D_{i,k}}{q_j} -
%     \pdiff{D_{k,j}}{q_i}\right)\dot{q}_k
%\]

% ---------- Hamiltonian Mechanics ---------- %
\subsection{Hamiltonian Mechanics}
Hamiltonian mechanics provides an equivalent representation of the EOM
by converting the \(n\) second-order ODEs generated by Lagrangian mechanics into
\(2n\) first-order ODEs.

To do this, we first define the \textit{conjugate of momentum \(p_i\) to \(q_i\)} by
\begin{equation}\label{eqn:p-i}
    p_i(q,\dot{q}) = \pdiff{\mathcal{L}}{\dot{q}_i}(q,\dot{q})
\end{equation}
To ease notation, we will write \(p = (p_1, \ldots, p_n) \in \R^n\) and say that
\(p\) is the \textit{conjugate of momenta to \(q\)}.
Note that each \(p_i\) is a linear function of \(\dot{q}\), so one can typically
solve for \(\dot{q}(q,p)\) by inverting the expressions from (\ref{eqn:p-i}).
The combined vector \((q,p) \in \mathcal{Q}\times\R^n\) is called a 
\textit{phase} of the system. 

The \textit{Hamiltonian} of the system in
\(\{q,p\}\) coordinates is defined as the Legendre transform 
(\ref{eqn:hamiltonian-legendre}) of the Lagrangian \cite{landau_mechanics}.
\begin{equation}\label{eqn:hamiltonian-legendre}
    \mathcal{H}(q,p) = p\tpose \dot{q}(q,p) - \mathcal{L}(q,\dot{q}(q,p))
\end{equation}
The EOM in this framework can be shown to be the \(2n\)
first-order equations called \textit{Hamilton's equations}
\begin{equation}\label{eqn:hamiltons-eqns}
    \begin{cases}
        \dot{q} = \nabla_p\mathcal{H} \\
        \dot{p} = -\nabla_q\mathcal{H} + B(q)\tau \\
    \end{cases}
\end{equation}
where \(B(q) \in \R^{n\times k}\) is the same input matrix used by the
Lagrangian and \(\tau \in \R^k\) is the vector of generalized input forces.

If the Lagrangian has quadratic kinetic energy as in (\ref{eqn:lagrangian}), 
the conjugate of
momenta to \(q\) can be computed explicitly by \(p = D(q)\dot{q}\).

% TODO: Replace [p D_i p] here with our new notation
The resulting Hamiltonian system reduces to (\ref{eqn:hamiltonian}).
\begin{align}\label{eqn:hamiltonian}
    \mathcal{H}(q,p) &= \frac{1}{2} p\tpose D^{-1}(q) p + P(q) \\
                     &\begin{cases}
        \dot{q} = D\inv(q)p \\
        \dot{p} = -\frac{1}{2} (\Id{n} \otimes p\tpose) \nabla_q D\inv(q) p
        - \nabla_q P(q) + B(q) \tau \\
    \end{cases} 
\end{align}

A set of coordinates \(\{q,p\}\) which satisfy Hamilton's equations 
under the Hamiltonian \(\mathcal{H}\) are
said to be \textit{canonical coordinates} for the system. A change of
coordinates \((q,p) \rightarrow (Q,P)\) is a \textit{canonical
transformation} if \(\{Q,P\}\) are canonical coordinates with Hamiltonian
\(H(Q,P) = \mathcal{H}\left(q(Q,P), p(Q,P)\right)\).

\section{Simply Actuated Hamiltonian Systems}
% TODO: Describe the change of coordinates to get into q_u/q_a mode and show
% that the actuator directly affects pa but not pu. Use M for simply actuated
% inertia, D for normal coordinates
Given a Hamiltonian mechanical system (\ref{eqn:hamiltonian}), it is not obvious
how the input forces \(\tau\) affect the conjugate of momenta \(p_i\). 
This is because \(\tau\) is transformed by the input matrix \(B(q)\), which may
be quite complicated. 

We will define a new class of Hamiltonian systems where the effect of the input
forces on the conjugate of momenta is made obvious. This class of systems will
form the backbone for the rest of the theory developed in this thesis.

\begin{defn}
    Let \(\mathcal{H}\) be an underactuated Hamiltonian system 
    \(\mathcal{H}\) with degree of underactuation \((n-k)\geq 0\). 
    A pair of canonical coordinates \(\{q,p\}\) for this system
    are said to be \textit{simply actuated coordinates} if the
    input matrix \(B(q) \in \R^{n \times k}\) is of the form
    \[
        B(q) = \simpleB    
    \]
    The first \((n-k)\) coordinates \(q_u\) are called the \textit{unactuated
    coordinates}, while the remaining \(k\) coordinates \(q_a\) are called the
    \textit{actuated coordinates}. We write \(q = (q_u, q_a)\) and the
    corresponding conjugate of momenta \(p = (p_u, p_a)\) are the called the
    unactuated and actuated momenta (respectively).
\end{defn}
\begin{defn}
    A Hamiltonian system is said to be \textit{simply actuated} if there exists
    a canonical transformation from any set of canonical coordinates 
    \(\{q,p\}\) into simply actuated coordinates for \(\mathcal{H}\).
\end{defn}

Under the following assumptions on the input matrix, we will show that the
Hamiltonian system (\ref{eqn:hamiltonian}) is simply actuated.

\begin{assm}\label{assm:B-const}
    The input matrix \(B(q) \equiv B \in \R^{n\times k}\) is constant,
    full rank, and \(k \leq n\).
\end{assm}
\begin{assm}\label{assm:B-perp}
    There exists a matrix 
    \(B^\perp \in \R^{(n-k)\times n}\)
    which is right semi-orthogonal 
    (\ie \(B^\perp(B^\perp)\tpose = \Id{(n-k)}\))
    and which is a left-annihilator for \(B\)
    (\ie \(B^\perp B = \Zmat{(n-k) \times k}\)).
\end{assm}

Note that if \(k = (n-1)\), the existence of any left annihilator \(A^0\) for
\(B\) implies the left annihilator \(B^\perp := A^0/\norm{A^0}\) satisfies Assumption
\ref{assm:B-perp}.

\begin{assm}\label{assm:B-orthogonal}
    Assume without loss of generality that the input matrix \(B\) is left
    semi-orthogonal.
    That is, assume \(B\tpose B = \Id{k}\).
\end{assm}
\begin{proof}
Since \(B\) is a constant matrix, 
it has a singular-value decomposition 
\(B = U \Sigma V\tpose\) where \(U^{-1} = U\tpose \in \R^{n \times n}\), 
\(V^{-1} = V\tpose \in \R^{k \times k}\), and \(\Sigma \in \R^{n \times k}\) is
defined by
\[
    \Sigma = \begin{bmatrix}
        \sigma_1 & 0 & \cdots & 0 \\
        0 & \sigma_2 & \cdots & 0 \\
        \vdots & & \ddots & \vdots \\
        0 & 0 & \cdots & \sigma_k \\
        - &   & \Zmat{(n-k)\times k} & -  \\
    \end{bmatrix}
\]
where \(\sigma_i \neq 0\) because \(B\) is full-rank \textbf{SOURCE?}.
Defining \(T \in \R^{k \times k}\) by
\[
    T = \begin{bmatrix}
        \frac{1}{\sigma_1} & 0 & \cdots & 0 \\
        0 & \frac{1}{\sigma_2} & \cdots & 0 \\
    \vdots & & \ddots & \vdots \\
    0 & 0 & \cdots & \frac{1}{\sigma_k} \\
    \end{bmatrix}
\]
and assigning the input forces to \(\tau = V T \hat{\tau}\), we get a new input
matrix for \(\hat{\tau} \in \R^k\) given by \(\hat{B} = B V T = U \Sigma T\) 
which is still constant and full-rank. In particular, 
\(\hat{B}\tpose \hat{B} = T\tpose \Sigma\tpose \Sigma\tpose T = \Id{k}\).
\end{proof}

Let \(\mathbf{B} \in \R^{n\times n}\) be the following matrix:
\[
    \mathbf{B} = 
    \begin{bmatrix}
        B^\perp \\
        B\tpose \\
    \end{bmatrix}
\]
Since \(B^\perp\) is a left annihilator of \(B\) and both \(B^\perp\) and
\(B\tpose\) are right semi-orthogonal, it is easy to show that \(\mathbf{B}\) is
orthogonal:
\[
    \mathbf{B}\mathbf{B}\tpose = 
    \begin{bmatrix}
        B^\perp (B^\perp)\tpose & B^\perp B \\
        (B^\perp B)\tpose & B\tpose B
    \end{bmatrix} = \Id{n}
    \Rightarrow
    \mathbf{B}^{-1} = \mathbf{B}\tpose
\]

The following theorem shows that \(\mathbf{B}\) provides a canonical
transformation into simply actuated coordinates, so that all unactuated momenta
are unaffected by the input forces.

% TODO: Replace the [P M_i P] with new notation
\begin{thm}
    Under Assumptions \ref{assm:B-const},\ref{assm:B-perp}, and
    \ref{assm:B-orthogonal}, the Hamiltonian system (\ref{eqn:hamiltonian}) is
    simply actuated with simply actuated coordinates 
    \(\{Q = \mathbf{B}q, P = \mathbf{B}p\}\). The resulting dynamics are 
    given by (\ref{eqn:simple-hamiltonian}),
    \begin{align}\label{eqn:simple-hamiltonian}
        \hat{H}(Q,P) &= 
        \frac{1}{2} P\tpose \Minv(Q) P + V(Q) \\
       &\begin{cases}
            \dot{Q} = \Minv(Q)P \\
            \dot{P} = -\frac{1}{2} (\Id{n} \otimes P\tpose) \nabla_Q \Minv(Q) P
                - \nabla_Q V(Q) + \simpleB \tau
        \end{cases} \nonumber
    \end{align}
    where
    \begin{align*}
        \Minv(Q) &:= \mathbf{B}D^{-1}(\mathbf{B}\tpose Q)\mathbf{B}\tpose \\
        V(Q) &:= P(\mathbf{B}\tpose Q) \\
    \end{align*}
\end{thm}
\begin{proof}
    The Poisson bracket between the functions \(f(q,p)\) and \(g(q,p)\) is defined by
    \cite{landau_mechanics} as follows:
    \[
        [f,g] := \sum \limits_{i=1}^n \pdiff{f}{p_i}\pdiff{g}{q_i} - 
                \pdiff{f}{q_i}\pdiff{g}{p_i}
    \]
    For any constant matrix \(A\), the transformation
    \(\{Q = Aq, P = Ap\}\) satisfies
    \(\pdiff{Q_i}{p_m} = \pdiff{P_i}{q_m} = 0\) for all 
    \(i,m \in \n\).
    Hence, for our new coordinates \(\{Q = \mathbf{B}q, P = \mathbf{B}p\}\),
    \begin{align*}
        [Q_i,Q_j] &:= \sum\limits_{m = 1}^n \pdiff{Q_i}{p_m}\pdiff{Q_j}{q_m} - 
        \pdiff{Q_i}{q_m}\pdiff{Q_j}{p_m} = 0 \\
        [P_i,P_j] &:= \sum\limits_{m=1}^n \pdiff{P_i}{p_m}\pdiff{P_j}{q_m} -
        \pdiff{P_i}{q_m}\pdiff{P_j}{p_m} = 0
    \end{align*}
    Since the matrix \(\mathbf{B}\) is orthogonal,
    \((\mathbf{B}_i)\tpose \mathbf{B}\tpose_j = (\mathbf{B}_i)\tpose (\mathbf{B}^{-1})_j = \delta_{i,j}\). Using this
    fact we see that the Poisson brackets between \(P\) and \(Q\) are given by:
    \begin{align*}
        [P_i,Q_j] &= \sum\limits_{m=1}^n\pdiff{P_i}{p_m}\pdiff{Q_j}{q_m}
        - \pdiff{P_i}{q_m}\pdiff{Q_j}{p_m} \\
                  &= \sum\limits_{m=1}^n \mathbf{B}_{i,m}\mathbf{B}_{j,m} - 0 \\
                  &= \sum\limits_{m=1}^n \mathbf{B}_{i,m}\mathbf{B}\tpose_{m,j} \\
                  &= (\mathbf{B}_i)\tpose \mathbf{B}\tpose_j \\
                  &= \delta_{i,j}
    \end{align*}

    Therefore, by (45.10) in \cite{landau_mechanics}, the coordinate change 
    \((Q = \mathbf{B}q, P = \mathbf{B}p)\) is a canonical transformation with
    new Hamiltonian 
    \(\hat{H}(Q,P) = \mathcal{H}(\mathbf{B}\tpose Q,\mathbf{B}\tpose P)\).

    Furthermore, since \(\dot{P} = \mathbf{B}\dot{p}\), the new input matrix is
    given by 
    \[
        \mathbf{B}B = \begin{bmatrix}
            B^\perp B \\
            B\tpose B \\
        \end{bmatrix} = 
        \begin{bmatrix}
            \Zmat{(n-k)\times k} \\
            \Id{k}
        \end{bmatrix}
    \]
    so the coordinates \(\{Q = (q_u,q_a), P = (p_u,p_a)\}\) are simply actuated coordinates for 
    \(\hat{H}\) as desired.
\end{proof}

\section{Virtual Nonholonomic Constraints}
% TODO: Motivation for VNHCs, they are an extension of VHCs, etc.
Let us imagine a child on a swing, who wants to go as high as possible. The
child will push off the ground and start swinging with small oscillations,
then extend and retract their feet appropriately to gain energy. 
If a roboticist were designing a machine to do this task, they might design a
control mechanism which makes the legs track a trajectory over time. For
example, they might tell the robot to extend and retract its legs every two
seconds. In ideal situtations, this technique would work perfectly because the
leg motion is synchronized with the swing to gain energy as fast as possible.

Most children have an adult pushing the swing to help them go higher; or perhaps
the child is swinging on a windy day. In either case, they adjust their leg
motion accordingly and do not keep track of time when kicking their legs. Te
standard control technique of tracking a function of time, known as
\textit{trajectory tracking}, would not work because the disturbance affecting
the swing will desynchronize the motion of the legs with the swing and stop the
energy-gaining effects.

This is a common issue in the control of many biologically-inspired systems. 
One method which can provide more realistic, robust motion is the method of
of virtual holonomic constraints (VHCs). Instead of a robot's actuators tracking
a trajectory over time, VHCs use the actuators to enforce a relation
\(h(q) = 0\) of the configuration \cite{vhcs_for_el_systems}. 
This method has provided incredible results in the development of 
walking robots \cite{vhc_robotic_walking, vhc_stable_walking}, 
vehicle motion \cite{vhc_bicycle, vhc_helicopter}, 
and has even been used to design a snake-like swimming robot
\cite{vhc_snake}.

Many authors have attempted to extend these results to enforce a relation 
\(h(q,\dot{q}) = 0\) of the full state. Since these relations use actuators to
restrict both the configuration and generalized velocity, they are called
virtual \textit{nonholonomic} constraints. This idea has been used for
human-robot interaction
\cite{vnhc_human_robot_cooperation,psd_based_vnhc_redundant_manipulator,haptic_vnhc},
error-reduction on time-delayed systems \cite{vnhc_time_delay_teleop},
and improving bipedal locomotion \cite{nhvc_dynamic_walking,
hybrid_zero_dynamics_bipedal_nhvcs,nhvc_incline_walking,output_nhvc_bipedal_control}.

Unlike the theory of VHCs, there does not appear to be a standard definition of virtual
nonholonomic constraints. One issue is that Lagrangian dynamics is not
particularly suited to finding controllers which stabilize desired constraints. Because
of this, all the applications listed above use their own definition of a virtual
nonholonomic constraint, which makes it difficult to compare and analyze their
work.

This section will provide a new characterization of virtual nonholonomic
constraints. The goal is to provide a consistent, rigorous foundation for
designing constraints on a general class of systems.

% TODO: Perform the full development of VNHCs, including its stabilizing
% controller.
\begin{defn}
    A \textit{virtual nonholonomic constraint} (VNHC) \textit{of order \(k\)} is a
    relation \(h(q,p) = 0\) where \(h : \mathcal{Q}\times\R^n \rightarrow \R^k\) is
    smooth, \(\rank{\left[ dh_q,\, dh_p \right]} = k\) for all 
    \((q,p) \in h\inv(0)\), and there exists a feedback controller \(\tau(q,p)\)
    stabilizing the set
    \[
        \Gamma = \left\{(q,p) \mid h(q,p) = 0, dh_q \dot{q} + dh_p \dot{p} = 0\right\}
    \]
    which is called the \textit{constraint manifold}.
\end{defn}

If we define the error term  \(e = h(q,p)\), stabilizing \(\Gamma\) is
equivalent to solving for \(\tau(q,p)\) which drives \(e \rightarrow 0\) and
\(\dot{e} \rightarrow 0\).
Let us imagine that we have no further structure on the VNHC. 
Then \(\dot{e} = dh_q \dot{q} + dh_p \dot{p}\), so \(\tau\) appears inside
\(\dot{e}\). To solve for \(\tau\) explicitly, we must have that \(dh_p\) is
invertible for all \(p\), which is the same as requiring that \(h(q,p)\) is
strictly monotonic in \(p\).

This is a very restrictive condition, which many VNHCs will not satisfy. For
this reason, it is preferable to have the torque \(\tau\) appear after two 
derivatives of \(e\) so that there is more freedom in the types of constraints
one can use.
Mathematically, if \(\tau\) appears only after two derivatives, one says 
that \(e\) is of \textit{relative degree} \(\{2,2,\ldots,2\}\). 
We thus define a special type of VNHC which satisfies this
property.

\begin{defn}
    A VNHC of order \(k\) \(h(q,p) = 0\) is \textit{regular} if the output 
    \(e = h(q,p)\) is of relative degree \(\{2,2.\ldots,2\}\) everywhere on the
    constraint manifold \(\Gamma\).
\end{defn}

Modifying the results of
\cite{nhvc_dynamic_walking,hybrid_zero_dynamics_bipedal_nhvcs,nhvc_incline_walking}
into the Hamiltonian framework, one observes that
relations which use only the unactuated momentum \(p_u\) result in \(\tau\)
appearing only after two derivatives of \(e\).
To be able to use \(p_u\), we will continue with the following assumption for
the rest of the chapter.

\begin{assm}\label{assm:H-is-simply-actuated}
    The mechanical system under consideration is a
    Hamiltonian system with \(n\) degrees of freedom and 
    \(k < n\) actuators. It is described in simply
    actuated coordinates \(\{q = (q_u,q_a), p = (p_u, p_a)\}\) and has the
    following dynamics:
    \begin{align*}
        \mathcal{H}(q,p) &= p\tpose \Minv(q) p + V(q) \\
         &\begin{cases}
            \dot{q} = \Minv p \\
            \dot{p} = -\frac{1}{2} \pdmat - \nabla_q V(q) + \simpleB \tau \\
        \end{cases}
    \end{align*}
\end{assm}
\begin{notation}
    We will write \(q_u \in \mathcal{Q}_u\), \(q_a \in \mathcal{Q}_a\) where
    \(\mathcal{Q}_u \times \mathcal{Q}_a = \mathcal{Q}\). 
    We also write
    \(p_u \in \mathcal{P}_u = \R^{n-k}\) and 
    \(p_a \in \mathcal{P}_a = \R^k\), so that 
    \(p \in \mathcal{P} := \mathcal{P}_u \times \mathcal{P}_a\). 
    In this manner, the phase space of our system can be written as
    \(\mathcal{Q} \times \mathcal{P}\).
\end{notation}

\begin{thm}\label{thm:vnhc-regularity}
    A VNHC of order \(k\) is regular if and only if \(dh_{p_a} = 0\) 
    and
    \[
        \rank{\left(dh_q \Minv(q) - 
          dh_{p_u} (\Id{n-k} \otimes p\tpose)\nabla_{q_u}\Minv(q) 
         \right)\simpleB} = k
    \]
    everywhere on the constraint manifold \(\Gamma\).
\end{thm}
\begin{proof}
    % TODO: complete this proof with our notation
    Let \(e = h(q,p) \in \R^k\). Then 
    \begin{align*}
        \dot{e} &= dh_q \dot{q} + dh_p \dot{p} \\
                &= dh_q \Minv(q)p +{}  \\
            & \begin{bmatrix} dh_{p_u} & dh_{p_a} \end{bmatrix}
        \left( -\frac{1}{2} \begin{bmatrix}
            (\Id{n-k} \otimes p\tpose) \nabla_{q_u}\Minv(q)p \\
            (\Id{k} \otimes p\tpose) \nabla_{q_a}\Minv(q)p
            \end{bmatrix} - \begin{bmatrix}
            \nabla_{q_u}V(q) \\
            \nabla_{q_a}V(q)
        \end{bmatrix} + \simpleB \tau\right)
    \end{align*}
    If \(dh_{p_a} \neq \Zmat{k \times k}\) for some \((q,p)\) on \(\Gamma\), 
    then \(\tau\) appears in \(\dot{e}\) and the VNHC is not of relative degree
    \(\{2,2,\ldots,2\}\).
    Hence, we must have that \(dh_{p_a} = \Zmat{k \times k}\) if we want the
    VNHC to be regular. Proceeding with this assumption, we now find that
    \(h : \mathcal{Q} \times \mathcal{P}_u \rightarrow \R^k\), which means
    \[
        \dot{e} = dh_q \Minv(q)p - 
        dh_{p_u} \left(\frac{1}{2} \pudmat + \nabla_{q_u}V(q)\right)
    \]
    Taking one further derivative provides
    \begin{align*}
        \ddot{e} &= \diff{}{t}\left\{dh_q\right\}\Minv(q) p + 
        dh_q \left(\sum\limits_{i=1}^n \pdiff{\Minv}{q_i}(q)\dot{q_i}\right)p + 
        dh_q \Minv(q) \dot{p} - \\
         & \diff{}{t}\left\{dh_{p_u}\right\}
         \left(\frac{1}{2}\pudmat + \nabla_{q_u}V(q)\right) - \\
         & dh_{p_u}\left(\frac{1}{2}\diff{}{t}\left\{\pudmat\right\} + 
         \diff{}{t}\left\{\nabla_{q_u}V(q)\right\} \right)
    \end{align*}
    We will compute the explicit expression of \(\ddot{e}\) in pieces. 
    First we begin with \(\diff{}{t}\left\{dh_q\right\}\). 
    Since \(h = (h^1,\ldots,h^k)\) where 
    \(h^i : \mathcal{Q} \times \mathcal{P}_u \rightarrow \R\), we have that 
    \[
        dh_q = \begin{bmatrix}
            dh^1_q \\
            \vdots \\
            dh^k_q
        \end{bmatrix} = \begin{bmatrix}
        \pdiff{h^1}{q_1} & \cdots & \pdiff{h^1}{q_n} \\
        \vdots & \ddots & \vdots \\
        \pdiff{h^k}{q_1} & \cdots & \pdiff{h^k}{q_n}
        \end{bmatrix}
    \]
    The derivative is taken element-wise in each matrix, yielding
    \[
        \diff{}{t}\left\{dh_q\right\} = \begin{bmatrix}
            \sum_{j=1}^n \ppdiff{h^1}{q_1}{q_j}\dot{q}_j & \cdots & \sum_{j=1}^n
            \ppdiff{h^1}{q_n}{q_j}\dot{q}_j \\
            \vdots & \ddots & \vdots \\
            \sum_{j=1}^n \ppdiff{h^k}{q_1}{q_j}\dot{q}_j & \cdots & \sum_{j=1}^n
            \ppdiff{h^k}{q_n}{q_j}\dot{q}_j \\
        \end{bmatrix} + \begin{bmatrix}
            \sum_{l=1}^{n-k}\ppdiff{h^1}{q_1}{p_{u_l}}\dot{p}_{u_l} & \cdots &
            \sum_{l=1}^{n-k}\ppdiff{h^1}{q_n}{p_{u_l}}\dot{p}_{u_l} \\
            \vdots & \ddots & \vdots \\
            \sum_{l=1}^{n-k}\ppdiff{h^k}{q_1}{p_{u_l}}\dot{p}_{u_l} & \cdots & 
            \sum_{l=1}^{n-k}\ppdiff{h^k}{q_n}{p_{u_l}}\dot{p}_{u_l} \\
        \end{bmatrix}
    \]
    It is straightforward computation to confirm that each row of this
    derivative can be written in vector form as follows:
    \begin{align*}
        \diff{}{t}\left\{dh^i_q\right\} &= \begin{bmatrix}
        \sum_{j=1}^n \ppdiff{h^i}{q_1}{q_j}\dot{q}_j & \cdots & 
        \sum_{j=1}^n \ppdiff{h^i}{q_n}{q_j}\dot{q}_j 
        \end{bmatrix} + \begin{bmatrix}
        \sum_{l=1}^{n-k}\ppdiff{h^i}{q_1}{p_{u_l}}\dot{p}_{u_l} & \cdots &
        \sum_{l=1}^{n-k}\ppdiff{h^i}{q_n}{p_{u_l}}\dot{p}_{u_l}
        \end{bmatrix} \\
       &= \dot{q}\tpose \Hess_q\left\{h^i\right\}\tpose + 
       \dot{p}_u\tpose \partial_{p_u}\partial_{q}h^i \\
       &= p\tpose \Minv(q)\Hess_q\left\{h^i\right\}\tpose -
       \left(\frac{1}{2}p\tpose d\Minv_{q_u}(q)(\Id{n-k}\otimes p) + 
       dV_{q_u}(q)\right)\partial_{p_u}\partial_{q}h^i
    \end{align*}
    This means that the entire matrix is given by
    \begin{align*}
        \diff{}{t}\left\{dh_q\right\} &= 
        \left(\Id{n} \otimes 
        \left(p\tpose \Minv(q)\right)\right)
        \Hess_q\left\{h\right\}\tpose -{} \\
      & \left(\frac{1}{2}\Id{n} \otimes 
          \left(p\tpose d\Minv_{q_u}(q)(\Id{n-k}\otimes p)\right)
        + \Id{n}\otimes dV_{q_u}(q)\right)\partial_{p_u}\partial_{q}h
    \end{align*}
    For the next segment, let \(e_j \in \R^n\) be the vector of all zeros,
    except for a single \(1\) at position \(j\). We define
    \(C_1 : \mathcal{Q} \times \mathcal{P} \rightarrow \R^{n\times n}\) by
    \[
        C_1(q,p) := \sum\limits_{j=1}^n \pdiff{\Minv}{q_j}(q)\dot{q}_j 
        = \sum\limits_{j=1}^n \pdiff{\Minv}{q_j}(q)\left(e_j\tpose\Minv(q)p\right)
    \]
    Moving on, one can use a similar approach to \(\diff{}{t}\left\{dh_q\right\}\)
    to find the derivative of \(dh_{p_u}\) in matrix form. It is given by
    \begin{align*}
        \diff{}{t}\left\{dh_{p_u}\right\} &= 
        \left( \Id{n} \otimes \left(p\tpose \Minv(q)\right)\right) 
        \partial_q\partial_{p_u}h -{} \\
      & \left(\frac{1}{2}\Id{n} \otimes \left(\pudmat\right) + 
      \Id{n} \otimes \nabla_{q_u}V(q)\right)\Hess_{p_u}\left\{h\right\}\tpose
    \end{align*}
    Now observe that the \(i^\text{th}\) row of
    \[
        \frac{1}{2} \diff{}{t} \left\{ \pudmat \right\}
    \]
    is given by
    \begin{align*}
        \frac{1}{2} \diff{}{t}\left\{p\tpose \pdiff{\Minv}{q_{u_i}}(q)p\right\}
        = p\tpose \pdiff{\Minv}{q_{u_i}}(q) \dot{p} + 
        \frac{1}{2} p\tpose \left( \sum_{j=1}^n \ppdiff{\Minv}{q_{u_i}}{q_j}
        \dot{q}_j \right) p
    \end{align*}
    Defining \(C_2 : \mathcal{Q} \times \mathcal{P} \rightarrow \R^{n(n-k)\times n}\)
    allows us to write the entire derivative in matrix form:
    \begin{align*}
        & \frac{1}{2} \diff{}{t} \left\{ \pudmat \right\} ={} \\
        & (\Id{n-k} \otimes p\tpose)\nabla_{q_u}\Minv(q)
        \left(-\frac{1}{2}\pudmat - \nabla_{q_u}V(q) + \simpleB \tau \right) +{}
        \\
        & \frac{1}{2}\left(\Id{n-k}\otimes p\tpose\right) C_2(q,p) p
    \end{align*}
    Finally, we compute the derivative of \(\nabla_{q_u}V(q)\)
    \[
        \diff{}{t}\left\{\nabla_{q_u}V(q)\right\} = 
        \begin{bmatrix}
            \sum_{j=1}^n \ppdiff{V}{q_{u_1}}{q_j}\dot{q}_j \\
            \vdots \\
            \sum_{j=1}^n \ppdiff{V}{q_{u_{n-k}}}{q_j}\dot{q}_j
        \end{bmatrix = \partial_{q_u} \partial_q V(q) \dot{q}
    \]
    and so we get that
    \[
        \diff{}{t}\left\{\nabla_{q_u}V(q)\right\} = 
        \partial_{q_u} \partial_q V(q) \Minv(q)p
    \]
    Putting this all together, we can find the explicit form for \(\ddot{e}\):
    \begin{align*}
        \ddot{e} &= \diff{}{t}\left\{dh_q\right\}\Minv(q)p + dh_q C_1(q,p)p -{}\\
     & \frac{1}{2}dh_q\Minv(q)(\pdmat) + 
        dh_q\Minv(q)\nabla_qV(q) -{}\\
     & \diff{}{t}\left\{dh_{p_u}\right\}
     \left(\frac{1}{2}\pudmat + \nabla_{q_u}V(q)\right) +{} \\
     & dh_{p_u}(\Id{n-k}\otimes p\tpose)\nabla_{q_u}\Minv(q)\left(
     \frac{1}{2}\pudmat + \nabla_{q_u}V(q)\right) -{}\\
     \frac{1}{2}dh_{p_u}(\Id{n-k}\otimes p\tpose)C_2(q,p)p - 
     dh_{p_u} \partial_{q_u}\partial_q V(q)\Minv(q)p +{} \\
     \left(dh_q \Minv(q) - dh_{p_u}(\Id{n-k} \otimes
     p\tpose)\nabla_{q_u}\Minv(q) \right) \simpleB \tau
    \end{align*}
    The VNHC \(h\) is regular iff \(e\) is of relative degree
    \(\{2,\ldots,2\}\), which is true iff \(\tau\) appears in each element of
    \(e\) on the constraint manifold. 
    Letting \(\ddot{e} = E(q,p) + H(q,p)\tau\), this is equivalent to requiring
    that the matrix \(H\) be full rank.
\end{proof}

Using the expression \(\ddot{e} = E(q,p) + H(q,p)\tau\) from the proof of 
Theorem \ref{thm:vnhc-regularity}, a regular VNHC of order \(k\) can be
stabilized by the output-linearizing phase-feedback controller
(\ref{eqn:vnhc-torque-controller}).
\begin{equation}\label{eqn:vnhc-torque-controller}
    \tau(q,p) = -H\inv(q,p)\left(E(q,p) + k_p e + k_d \dot{e}\right)
\end{equation}
where \(k_p, k_d \in \R_{>0}\) are control parameters which can be tuned on the
resulting linear system \(\ddot{e} = -k_p e - k_d\dot{e}\). 

Note that one generally cannot measure conjugate of momenta directly, as sensors
on mechanical systems typically only measure the state \((q,\dot{q})\). To
implement this controller in practice, one must compute \(p = M(q)\dot{q}\) at
every iteration. In other words, this controller requires knowledge of the full
state of the system.

%TODO: Special case: when dM/dqu = 0, show that we have a nice form and that we
%can solve for p_a and the closed-loop dynamics (qu,pu)_dot

Now that we have found a controller to enforce a regular VNHC of order \(k\), we
would like to solve for the closed-loop dynamics. Naturally, these dynamics
should be specified through \((q_u, p_u)\) since \(q_a\) is a function of these
as specified by \(h(q,p_u) = 0\).
Unfortunately, \(\dot{q}_u\) depends on \(p_a\), and for general systems one
cannot solve explicitly for \(p_a\) in terms of \((q_u,p_u)\). This is because
the \(\dot{p}\) dynamics contains the coupling term 
\((\Id{n} \otimes p\tpose)\nabla_{q_u}M(q)p\). 

We now introduce a class of systems where explicitly solving for the closed-loop
dynamics is feasible.

\begin{defn}
    A mechanical system is ------ if \(\nabla_{q_u}M(q) = 0\)
\end{defn}

\begin{thm}\label{thm:zero-dynamics}
    Let \(\mathcal{H}\) be a ----- mechanical system satisfying Assumption
    \ref{assm:H-is-simply-actuated}. Let
    \(h(q,p_u) = 0\) be a regular VNHC of order \(k\) with constraint manifold
    \(\Gamma\).
    Then, on \(\Gamma\), the closed-loop dynamics are given by
    \begin{equation}\label{eqn:qpu-dynamics}
        \left.\begin{aligned}
            \dot{q}_u &= M(q)p \\
            \dot{p}_u &= -\nabla_{q_u}V(q) \\
            \end{aligned}\right|_{\begin{array}{c}
                h(q,p_u) = 0 \\ 
                pa = g(q_u,p_u) \\
            \end{array}}
    \end{equation}
    where
    \begin{equation}\label{eqn:g-qpu}
    \begin{aligned}
        g(q,p_u) &:= \\
           &\left.\left(dh_q \Minv(q) \simpleB \right)\inv 
        \left(dh_{p_u} \nabla_{q_u}V(q) - dh_q \Minv(q)
        \begin{bmatrix}
            I_{n-k} \\
            \Zmat{k \times (n-k)} \\
        \end{bmatrix} p_u\right)\right|_{h(q,p_u) = 0}
    \end{aligned}
    \end{equation}
\end{thm}
\begin{proof}
%TODO: Complete the proof for this theorem
\end{proof}

The most fascinating part of Theorem \ref{thm:zero-dynamics} is that it shows
that the dynamics on \(\Gamma\) are entirely described by the \(2(n-k)\)
unactuated coordinates, regardless of the number of degrees of freedom of the
system. This means that \(\Gamma\) is a \(2(n-k)\)-dimensional surface from
which the system cannot escape. This becomes especially important when analyzing
systems of degree of underactuation one, since it means the constraint is always
a curve which can be plotted on the plane with axes \(q_u\) and \(p_u\)
regardless of the original dimension \(n\) of the system. 

In future sections of this thesis, we will apply a very specific type of
constraint. The following corollay applies Theorem \ref{thm:zero-dynamics} to
these constraints.

\begin{cor}\label{cor:2d-zero-dynamics}
    Suppose \(\mathcal{H}\) is a ---- mechanical system satisfying Assumption
    \ref{assm:H-is-simply-actuated} which has degree of underactuation one.
    Let \(h(q,p_u) = q_a - f(q_u,p_u)\) be a regular VNHC of order \((n-1)\),
    where \(f\) is a suitably-defined smooth function.
    Defining \(e_1 := (1,0,\ldots,0) \in \R^n\), the actuated momentum 
    is given by
    \begin{equation}\label{eqn:g-qupu}
        p_a = -\left.\left(dh_q \Minv(q)
        \begin{bmatrix}
            \Zmat{1\times (n-1)}\\
            I_{(n-1)}
        \end{bmatrix}\right)\inv 
        \left(\partial_{p_u}f \partial_{q_u}V + dh_q \Minv(q)e_1 p_u\right) 
            \right|_{q_a =f(q_u,p_u)}
    \end{equation}
    Since \(q_u \in \Rt{T}\) for some \(T > 0\), \((q_u(t),p_u(t))\) traces out
    a curve on the so-called \((q,p)\)-plane \(\Rt{T} \times \R\).
\end{cor}

\section{Summary of Results}
%TODO: summarize the assumptions and results 















%\section{Virtual Nonholonomic Constraints}\label{sec:vnhcs}
%
%%----- Motivation -----%
%\subsection{Motivation}
%\textbf{TODO: Why do we bother with Hamiltonian? Why can't we do virtual nonholonomic 
%constraints in Lagrangian? What are some use-cases where VHCs don't work?}
%
%%---------- Hamiltonian from Lagrangian ----------%
%\subsection{Review: Hamiltonian Systems}
%\textbf{TODO: What is a Hamiltonian system and why does it matter?}
%
%One can compute the Hamiltonian of a system by performing a Legendre transform
%on its Lagrangian \textbf{TODO: citation for legendre transform}.
%First, define the conjugate of momenta for \(q\) by 
%\begin{equation*}
%p = \frac{\partial \mathcal{L}}{\partial \dot{q}} \in \mathbb{R}^n
%\end{equation*}
%Then, the Legendre transform is performed by taking
%\begin{equation*}
%\mathcal{H}(q,p) = p^T \dot{q} - \mathcal{L}(q,\dot{q})
%\end{equation*}
%
%For a mechanical system (\ref{eqn:lagrangian}), the conjugate of momenta for
%\(q\) is given by 
%\begin{equation*}
%    p = M(q)\dot{q}
%\end{equation*}
%which means the Hamiltonian of the system is given by
%the total mechanical energy \(E\) (\ref{eqn:hamiltonian} in 
%\((q,p)\) coordinates.
%\begin{equation}\label{eqn:hamiltonian}
%\mathcal{H}(q,p) = E(q,p) = \frac{1}{2} p^T \Minv(q) p + V(q)
%\end{equation}
%Note that \(M(q)\) is the inertia matrix and \(V(q)\) is the potential for
%the Hamiltonian system. This is simply a trick to distinguish them notationally
%from the Lagrangian \(D(q)\) and \(P(q)\); they are, in fact, identical in their
%contents.
%
%The equations of motion for the system in Hamiltonian coordinates is given by
%\begin{align}\label{eqn:hamiltionian_eom}
%\begin{split}
%\dot{q} &= \frac{\partial \mathcal{H}}{\partial p} = \Minv(q) p \\
%\dot{p} &= -\frac{\partial \mathcal{H}}{\partial q} + B \tau
%\end{split}
%\end{align}
%
%\textbf{Why bother looking at Hamiltonian systems? What is the intuition behind
%these equations of motion?}
%
%%---------- Hamiltonian VNHCs ----------%
%\subsection{Hamiltonian Virtual Nonholonomic Constraints}
%While VHCs are still possible in the Hamiltonian framework, the assumptions
%required to make this work are slightly different. Rather than deriving
%Hamiltonian VHCs directly, we will produce results for nonholonomic constraints
%first as VHCs are a special case of this new framework.
%
%Suppose the mechanical system has degree of underactuation one, so that coordinates of the system can be split into an unactuated component \(q_u \in [\mathbb{R}]_T, \, T \in \mathbb{R}_{>0}\) which is not influence by control, along with an actuated component \(q_a\); that is, suppose \(B\) is of the form \(B(q) = [0_m, B_1^T(q), \ldots, B_n^T(q)]^T, \, B_i^T(q) \in \mathbb{R}^{n-1}\) and \(\tau \in \mathbb{R}^{n-1}\). In this case, \(q = (q_u, q_a)^T\) and the equations of motion become
%\begin{align}\label{eqn:unactuated_actuated_eom}
%\begin{split}
%\dot{q_u} &= e_1^T \Minv(q) p \\
%\dot{p_u} &= -p^T\frac{\partial M}{\partial q_u} p - \partial_{q_u}V(q) \\
%\dot{q_a} &= 
%\begin{bmatrix}
%0 \cdots 0 \\
%I_{n-1} \\
%\end{bmatrix} \Minv(q) p \\
%\dot{p_a} &= -p^T\frac{\partial M}{\partial q_a} p - \nabla{q_a}V(q) + 
%\begin{bmatrix}
%B_1(q) \\
%\vdots \\
%B_n(q)
%\end{bmatrix} \tau
%\end{split}
%\end{align}
%
%Now we can begin to talk about Virtual Nonholonomic Constraints. In a similar fashion to what was defined for VHCs, let us first define the goal of these new virtual constraints.
%
%\begin{defn}
%A relation \(h \in C^2\left(\mathcal{Q}\times \mathbb{R}^n ; \mathbb{R}^k\right)\) with \(h(q,p) = 0\) is a \textbf{virtual nonholonomic constraint (VNHC) of order k} if there exists a feedback control \(\tau(q,p)\) which stabilizes the constraint manifold
%\[
%\Gamma = \left\{(q,p) | h(q,p) = 0, dh_q \dot{q} + dh_p \dot{p} = 0\right\}
%\]
%\end{defn}
%Define the output of the system to be \(e = h(q,p)\). We would like to find \(\tau(q,p)\) which drives \(e\) to zero to stabilize our constraint manifold \(\Gamma\). To accomplish this, we will input-output linearize (\ref{eqn:unactuated_actuated_eom}) to find \(\ddot{e} = -k_p e - k_d \dot{e}\) with \(k_p, k_d \in \mathbb{R}_{> 0}\).
%
%To characterize a certain class of VNHCs, let us make the following assumption.
%\begin{assm}\label{assm:vnhc_is_on_qu_pu}
%We assume our relation \(h\) is of the form \(h(q,p) = q_a - f(q_u,p_u)\) for some \(f \in C^2\left([\mathbb{R}]_T \times \mathbb{R} ; \mathbb{R}^{n - 1}\right)\).
%\end{assm}
%
%Now we solve for \(\tau\) by finding \(\ddot{e}\).
%\begin{align*}
%    e &= h(q,p) = qa - f(q_u,p_u)\\
%    \Rightarrow \dot{e} &= \dot{q_a} - df_{q_u}\dot{q_u} -df_{p_u}\dot{p_u} \\
%    &= [-df_{q_u} I_{n-1}]\dot{q} - df_{p_u} \dot{p_u} \\
%    &= dh_q \Minv(q) p - df_{p_u}\left( -\frac{1}{2}p^T \frac{\partial \Minv(q)}{\partial q_u} p - \partial_{q_u}V(q) \right) \\
%    &= dh_q \Minv(q) p + \frac{1}{2}df_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u} p + df_{p_u}\partial_{q_u}V(q)
%\end{align*}
%The control input \(\tau\) only appears in \(\dot{p_a}\) (see (\ref{eqn:unactuated_actuated_eom})). To simplify the analysis, terms in \(\ddot{e}\) which do not depend on \(\dot{p_a}\) explicitly are lumped together under the symbol \((*)\):
%\begin{align*}
%    \ddot{e} &= dh_q \Minv(q) \dot{p} + df_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u} \dot{p} + (*) \\
%    &= (dh_q \Minv(q) + df_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u})B\tau + (*) \\
%    &= (dh_q \Minv(q) + dh_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u})B\tau + (*)
%\end{align*}
%
%From the derivations above, one can solve for \(\tau\) iff the matrix on the left of \(\tau\) is full rank. Thus, for systems with degree of underactuation one we give the following definition.
%\begin{defn}
%A VNHC \(h(q,p) = 0\) of order \(n - 1\) is \textbf{regular} if \(dh_{p_a} = 0\), \(dh_{q_a} = (1 \ldots 1)^T\), and 
%\[
%\text{rank}\left\{ (dh_q \Minv(q) + dh_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u})B\right\} = n - 1
%\]
%everywhere on the constraint manifold \(\Gamma\). Equivalently, a VNHC \(h\) of order \(n - 1\) is regular if it satisfies Assumption \ref{assm:vnhc_is_on_qu_pu} and system (\ref{eqn:unactuated_actuated_eom}) with output \(e = h(q,p)\) is of relative degree \(\{2,2,\ldots,2\}\) everywhere on \(\Gamma\).
%\end{defn}
%
%In general, \(\dot{e}\) is a function of \(q_u\) and \(p = (p_u,p_a)^T\). Since the purpose of a regular VNHC is to fully parameterize \(\Gamma\) by \((q_u,p_u)\), it is essential that one can solve for \(p_a = p_a(q_u,p_u)\). Unfortunately this often cannot be done, since \(\dot{e}\) contains the quadratic term
%\[
%\frac{1}{2} df_{p_u} p^T \frac{\partial \Minv(q)}{\partial q_u} p 
%\]
%We can solve for \(p_a\) if this quadratic term does not exist.
%\begin{assm}\label{assm:M_is_Mqa}
%Assume \(\partial M(q) / \partial q_u = 0 \Leftrightarrow \partial \Minv(q) / \partial q_u = 0\)
%\end{assm}
%
%Under Assumption \ref{assm:M_is_Mqa}, we get that the rank condition for \(h(q,p)\) to be a regular VNHC reduces to \(\text{rank}\left(dh_q \Minv B\right) = n - 1\). This is the same rank condition as required for Virtual Holonomic Constraints.
%
%Now we solve for \(p_a\) on the constraint manifold (when \(e = \dot{e} = 0\)):
%\begin{align*}
%    \dot{e} = dh_q \Minv(q)p + df_{p_u} \partial_{q_u}V(q) &= 0\\
%    \Leftrightarrow dh_q \Minv(q)e_1 p_u + dh_q \Minv(q) \begin{bmatrix}
%    0 & \cdots & 0 \\
%    & I_{n-1} & \\
%    \end{bmatrix} p_a &= -df_{p_u} \partial_{q_u}V(q) \\
%\end{align*}
%\begin{align*}
%    \Leftrightarrow dh_q \Minv(q) \begin{bmatrix}
%    0 & \cdots & 0 \\
%    & I_{n-1} & \\
%    \end{bmatrix} p_a = -\left(df_{p_u}\partial_{q_u}V(q) + dh_q \Minv(q)e_1 p_u\right)
%\end{align*}
%One can linearly solve for \(p_a\) if and only if the matrix in front of it is invertible.
%
%This leads us to a natural definition.
%\begin{defn}\label{defn:solvability}
%A VNHC \(h(q,p)\) is \textbf{solvable} (NOTE: actionable? what's a good name?) if
%\[
%\text{rank}\left(dh_q \Minv(q) \begin{bmatrix}
%    0 & \cdots & 0 \\
%    & I_{n-1} & \\
%    \end{bmatrix}\right) = n - 1
%\]
%\end{defn}
%
%With this analysis and our new definition in hand, we can solve for the dynamics on the constraint manifold.
%
%\begin{thm}\label{thm:equation_for_pa}
%Suppose assumptions \ref{assm:vnhc_is_on_qu_pu} and \ref{assm:M_is_Mqa} hold.
%If a regular VNHC \(h(q,p) = q_a - f(q_u,p_u)\) is solvable, then the
%parameterization for \(p_a\) on the constraint manifold is given by
%\begin{align*}
%p_a &= -\left(dh_q \Minv(q) \begin{bmatrix}
%    0 & \cdots & 0 \\
%    & I_{n-1} & \\
%    \end{bmatrix}\right)^{-1}\left( df_{p_u}\partial_{q_u}V(q) + dh_q \Minv(q)e_1 p_u\right) \\
%    &=: g(q_u,p_u)
%\end{align*}
%and the constrained dynamics on \(\Gamma\) are given by
%\begin{align*}
%    \dot{q_u} &= e_1^T \Minv(q_a) \begin{bmatrix}
%    p_u \\
%    p_a
%    \end{bmatrix}\mid_{q_a = f(q_u,p_u), p_a = g(q_u,p_u)} \\
%    \dot{p_u} &= -\partial_{q_u} V(q_u,q_a) \mid_{q_a = f(q_u,p_u)}
%\end{align*}
%\end{thm}
%
%Theorem \ref{thm:equation_for_pa} guarantees that, on \(\Gamma\), \(q_a\) is a
%parameterized completely by \((q_u,p_u)\). Hence, the zero-dynamics on
%\(\Gamma\) are always two-dimensional regardless of the original dimension
%\(n\).
%
%%---------- Hamiltonian VHCS ---------%
%\subsection{Restriction to Hamiltonian VHCs}
%\textbf{TODO: Why can we not do the standard VHC approach for Hamiltonian? 
%Show how to use the above to make it work}
%
%%/========== /Virtual Nonholonomic Constraints ==========/% 
% vim: set tw=80 ts=4 sw=4 sts=0 et ffs=unix :
