%! TEX root = main.tex

%/========== Virtual Holonomic Constraints ==========/%
\section{Virtual Holonomic Constraints}\label{sec:vhcs}

\subsection{Review: Lagrangian Virtual Holonomic Constraints}
Take an underactuated mechanical system with Lagrangian
\begin{equation}\label{eqn:lagrangian}
\mathcal{L}(q,\dot{q}) = \frac{1}{2} \dot{q}^T D(q) \dot{q} - P(q)
\end{equation}
where \(q = (q_1,\ldots,q_n) \in \mathcal{Q}\) is the configuration vector, 
the inertia matrix \(D(q) = D^T(q)\) is positive definite for all 
\(q \in \mathcal{Q}\), and \(P(q)\) is the potential of the system.


The equations of motion for this system can be computed from 
the Euler-Lagrange equations (\ref{eqn:el_eqns})
\begin{equation}\label{eqn:el_eqns}
   \frac{d}{dt} \left( \frac{\partial \mathcal{L}}{\partial \dot{q}}\right) -
   \frac{\partial \mathcal{L}}{\partial q} = B(q)\tau
\end{equation}
which result in (\ref{eqn:eom_lagrangian}), where
\(C : T\mathcal{Q} \rightarrow \mathbb{R}^{n \times n}\) represents the
generalized coriolis and centrifugal forces,
\(B : \mathcal{Q} \rightarrow \mathbb{R}^{n \times m}\) is a 
\(C^1\) full rank control matrix, and \(\tau \in \mathbb{R}^{m}\) is the control 
input. \textbf{TODO: citation for E-L equations}

\begin{equation}\label{eqn:eom_lagrangian}
D(q)\ddot{q} + C(q,\dot{q})\dot{q} + \nabla P(q) = B(q)\tau
\end{equation}

Suppose one were to use the control input \(\tau\) to enforce a
constraint on the generalized coordinates which depends only on \(q\) and not on
\(\dot{q}\). This type of constraint is called ``holonomic"; since the 
constraint is enforced by control as opposed to being a feature of the mechanics
of the system, it is a called a ``virtual" constraint. 
This intuition leads to the following mathematical development, described in 
\cite{vhcs_for_el_systems}:

\begin{defn}\label{defn:vhc_order_k}
   A \textbf{virtual holonomic constraint (VHC) of order k} is a smooth relation 
   \( h : \mathcal{Q} \rightarrow \mathbb{R}^k\) where
   \( \text{rank}(dh_q) = k \, \forall q \in h^{-1}(0)\) and where there exists
   a smooth feedback controller \(\tau(q,\dot{q})\) such that the constraint
   manifold
   \[
      \Gamma = \left\{ (q,\dot{q}) \in T_q\mathcal{Q} \vert h(q) = 0, \, 
      dh_q \dot{q} = 0\right\}
   \]
   is positively invariant.
\end{defn}

Typically in the theory of VHCS, one focuses mostly on VHCs of order \((n-1)\).
This is because \(h^{-1}(0) = \{q \in \mathcal{Q} \vert h(q) = 0\}\) is a
\((n-k)\)-dimensional submanifold of \(\mathcal{Q}\); if a VHC is of order
\((n-1)\), then (by the preimage theorem) once the system is on \(\Gamma\), the
set \(h^{-1}(0)\) is a 1-dimensional curve with no self-intersections which can
be parameterized by a single configuration variable. In other words, VHCs of
order \((n-1)\) reduce the dimension of the system to a 2-dimensional state,
parameterized by some new virtual configuration and its velocity.  If \(k <
(n-1)\), it becomes much more difficult to analyse the system under constraint
since it gains more degrees of freedom. Therefore it is assumed for the rest of
this section that any VHC is of order \((n-1)\).

\begin{defn}\label{defn:vhc_regular}
   A VHC of order \((n-1)\) is \textbf{regular} if 
   system (\ref{eqn:eom_lagrangian}) with output \(e = h(q)\) has vector
   relative degree \(\{2,2,\ldots,2\}\) on \(\Gamma\).
   Equivalently, a VHC is regular if 
   \[
      dh_q D^{-1}(q)B(q)
   \]
   is nonsingular everywhere on \(\Gamma\).
\end{defn}

The definition of regularity comes from the following: 
let \(h\) be a VHC and let \(e = h(q)\) be the
output of (\ref{eqn:eom_lagrangian}). If \(h\) is regular, then
it is possible to input-output
linearize the system to get \(\ddot{e} = -k_p e - k_d \dot{e}\). This
in turn means \(\Gamma\) becomes control-invariant and asymptotically
stabilizable.

To show this, we repeat the derivation of
\textcite{vhcs_for_el_systems,lagrangian_structure_reduced_dynamics_vhcs} and take
derivatives of \(e\).

\begin{align*}
   \dot{e} &= dh_q \dot{q} \\
   \ddot{e} &= dh_q \ddot{q} + \frac{d}{dt}\left(dh_q\right)\dot{q}\\
   \Rightarrow \ddot{e} &= 
      -dh_qD^{-1}(q)\left[C(q,\dot{q})\dot{q} + \nabla P(q) \right] 
      + \begin{bmatrix}
         \dot{q}^T \nabla^2 h_1(q) \dot{q} \\
         \vdots \\
         \dot{q}^T \nabla^2 h_{n-1}(q) \dot{q}
      \end{bmatrix}
      + dh_q D^{-1}(q)B\tau \\
\end{align*}

Let \(\mu(q,\dot{q})\) be given by 
\begin{equation*}
   \mu(q,\dot{q}) := -dh_qD^{-1}(q)\left[C(q,\dot{q})\dot{q} + \nabla P(q) \right] 
      + \begin{bmatrix}
         \dot{q}^T \nabla^2 h_1(q) \dot{q} \\
         \vdots \\
         \dot{q}^T \nabla^2 h_{n-1}(q) \dot{q}
      \end{bmatrix}
\end{equation*}
Then the resulting error dynamics are
\begin{equation}\label{eqn:vhc_error_dynamics}
   \ddot{e} = \mu(q,\dot{q}) + dh_q D^{-1}B(q) \tau
\end{equation}

Since \(h\) is a regular VHC, it is possible to solve for the control input. 
The controller
\begin{equation*}
   \tau(q,\dot{q}) = \left(dh_q D^{-1}B(q)\right)^{-1}\left[-k_p e - k_d \dot{e} -
   \mu(q,\dot{q})\right]
\end{equation*}
will generate the linear error dynamics \(\ddot{e} = -k_p e - k_d\dot{e}\) 
which make \(\Gamma\) asymptotically stable.

After constructing this controller, a natural question to ask is how system
(\ref{eqn:eom_lagrangian}) behaves once it has stabilized on the constraint
manifold \(\Gamma\). For this, one must make the following assumption.

\begin{assm}\label{assm:B_perp_exists}
   There exists \(B^\perp(q) \in \mathbb{R}^{(n-1) \times n}\) such that
   \[
      B^\perp(q) B(q) = 0 \in \mathbb{R}^{(n-1)\times(n-1)} \, \forall q \in
   \mathcal{Q}
   \]
\end{assm}

Given some \(B^\perp\), one can left-multiply the equations of motion to get
\begin{equation}\label{eqn:eom_lagrangian_with_B_perp}
   B^\perp(q)D(q)\ddot{q} + B^\perp(q)\left(C(q,\dot{q})\dot{q} \nabla
   P(q)\right) = 0
\end{equation}

Recall that, since \(h\) is a regular VHC of order \((n-1)\), the dynamics under
constraint can be parameterized by a single configuration variable.  If the
dynamics on \(\Gamma\) are non-periodic, then the curve \(h^{-1}(0)\) is
diffeomorphic to \(\mathbb{R}\). In this case, define \(\Theta := \mathbb{R}\).
Otherwise, if the dynamics on \(\Gamma\) are periodic with some period \(T > 0\), 
then the curve \(h^{-1}(0)\) is diffeomorphic to the circle
\(\mathbb{S}^1\). In this case, let \(\Theta := [\mathbb{R}]_T\).

As in \cite{lagrangian_structure_reduced_dynamics_vhcs}, 
now \(s \in \Theta\) be the virtual configuration which parameterizes
\(h^{-1}(0)\) through the diffeomorphism 
\begin{align*}
   \sigma : \Theta &\rightarrow h^{-1}(0) \\
   s &\mapsto q
\end{align*}
Likewise, the tangent bundle \(T\Theta\) is diffeomorphic to \(Gamma\) 
through the mapping
\begin{align*}
   d\sigma : T\Theta &\rightarrow \Gamma \\
   (s,\dot{s}) &\mapsto (q,\dot{q})
\end{align*}

Using this new virtual configuration, the state of system
(\ref{eqn:eom_lagrangian}) on the constraint manifold
is parameterized by \(q = \sigma(s)\) and \(\dot{q} = \sigma'(s)\dot{s}\).
Inserting these into (\ref{eqn:eom_lagrangian_with_B_perp}) (and dropping the
function notation on \(B\),\(D\),\(C\), and \(P\) for simplicity), one gets
\begin{align*}
   B^\perp D\left(\sigma'(s)\ddot{s} + \sigma"(s)\dot{s}^2 \right)
   + B^\perp \left[ C \sigma'(s)\dot{s} + \nabla P \right] = 0
\end{align*}

By how \(C(q,\dot{q})\) is defined, 
one can collect the product \(B^\perp C \dot{q}\) in the following way.
First, combine the Christoffel symbols  into a matrix
\(Q_i : \mathcal{Q} \rightarrow \mathbb{R}^{n \times n}\)
defined element-wise by
\begin{equation*}
   [Q_i]_{j,k}(q) = \frac{1}{2}\left(\partial_{q_k} [D]_{i,j}(q)
      + \partial_{q_j} [D]_{i,k}(q) 
      + \partial_{q_i} [D]_{k,j}(q)\right)
\end{equation*}

Then \(B^\perp C \dot{q}\) becomes
\begin{equation*}
   \sum \limits_{i=1}^n B_i^\perp \dot{q}^T Q_i
\end{equation*}

To simplify the notation, define 
\begin{align*}
   \Psi_1(s) &:= -\frac{B^\perp \nabla P}{B^\perp D \sigma'} \\
   \Psi_2(s) &:= -\frac{B^\perp D \sigma" + \sum\limits_{i=1}^n B_i^\perp
   {\sigma'}^T Q_i \sigma'}{B^\perp D \sigma'} 
\end{align*}

Hence, the constrained dynamics for any regular VHC of order \((n-1)\) are
provided entirely by the single, second-order system 
(\ref{eqn:lagrangian_constrained_dynamics}).
\begin{equation}\label{eqn:lagrangian_constrained_dynamics}
   \ddot{s} = \Psi_1(s) + \Psi_2(s)\dot{s}^2
\end{equation}

A natural question to ask is whether these constrained dynamics are also
Lagrangian. In fact, for VHCs applied to mechanical systems, the dynamics are
Euler-Lagrange. \cite{lagrangian_structure_reduced_dynamics_vhcs}

To see this, suppose the constrained dynamics had Lagrangian given by
\begin{equation*}
   \mathcal{L}_{\Psi}(s,\dot{s}) = \frac{1}{2}
   D_{\Psi}(s)\dot{s}^2 + V_{\Psi}(s)
\end{equation*}
where \(D_{\Psi} : \Theta \rightarrow \mathbb{R}_{>0}\) is the virtual mass
and \(V_{\Psi} : \Theta \rightarrow \mathbb{R}\) is the virtual potential of the
system. Then the equations of motion of this system are
\begin{equation*}
   D_{\Psi}'(s)\dot{s}^2 + D_{\Psi}(s)\ddot{s} - \frac{1}{2}D_{\Psi}'(s)\dot{s}
   + V_{\Psi}'(s) = 0
\end{equation*}
\begin{equation}\label{eqn:lagrangian_constrained_dynamics_general}
   \Rightarrow \ddot{s} = -\frac{V_{\Psi}'(s)}{D_{\Psi}(s)} -
   \frac{D_{\Psi}'(s)}{2 D_{\Psi}(s)}
\end{equation}

Setting (\ref{eqn:lagrangian_constrained_dynamics}) and
(\ref{eqn:lagrangian_constrained_dynamics_general}) equal to each other, one
can compute the values of \(D_{\Psi}\) and \(V_{\Psi}\). First, one sees that
\(V_{\Psi}(s)\) is defined by \(D_{\Psi}\) and \(\Psi_1\):
\begin{align*}
   \Psi_1(s) &= -\frac{V_{\Psi}'(s)}{D_{\Psi}(s)} \\
   \Rightarrow V_{\Psi}'(s) &= -D_{\Psi}(s) \Psi_1(s) \\
   \Rightarrow V_{\Psi}(s) &= - \int \limits_{0}^s
   D_{\Psi}(\tau)\Psi_1(\tau)d\tau
\end{align*}
where \(D_{\Psi}\) is given by
\begin{align*}
   \Psi_2(s) &= -\frac{D_{\Psi}'(s)}{D_\Psi(s)} \\
   \Rightarrow D_{\Psi}'(s) &= -D_{\Psi}(s) \Psi_2(s) \\
   \Rightarrow D_{\Psi}(s) &= \exp\left[ 
   -2\int \limits_{0}^s \Psi_2(\tau) d\tau \right]
\end{align*}

\subsection{Review: Hamiltonian Systems}
\textbf{TODO: What is a Hamiltonian system and why does it matter?}

One can compute the Hamiltonian of the Lagrangian (\ref{eqn:lagrangian}) by 
performing a Legendre transform on the Lagrangian. 
First, define the conjugate of momenta for \(q\) by 
\begin{equation*}
p = \frac{\partial \mathcal{L}}{\partial \dot{q}} \in \mathbb{R}^n
\end{equation*}
Then, the Legendre transform is performed by taking
\begin{equation*}
\mathcal{H}(q,p) = p^T \dot{q} - \mathcal{L}(q,\dot{q})
\end{equation*}
It is easy to verify that the Hamiltonian for system (\ref{eqn:lagrangian}) is 
given by the total mechanical energy (\ref{eqn:hamiltonian}).
\begin{equation}\label{eqn:hamiltonian}
\mathcal{H}(q,p) = E(q,p) = \frac{1}{2} p^T M^{-1}(q) p + V(q)
\end{equation}

The equations of motion for the system in Hamiltonian coordinates is given by
\begin{align}\label{eqn:hamiltionian_eom}
\begin{split}
\dot{q} &= \frac{\partial \mathcal{H}}{\partial p} = M^{-1}(q) p \\
\dot{p} &= -\frac{\partial \mathcal{H}}{\partial q} + B \tau
\end{split}
\end{align}

\textbf{Why bother looking at Hamiltonian systems? What is the intuition behind
these equations of motion?}

\subsection{Hamiltonian Virtual Nonholonomic Constraints}

%/========== /Virtual Holonomic Constraints ==========/%
% vim: set tw=80 ts=3 sw=3 sts=0 et ffs=unix :
