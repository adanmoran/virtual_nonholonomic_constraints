%! TEX root = main.tex

%/========== Virtual Holonomic Constraints ==========/%
\section{Virtual Holonomic Constraints}\label{sec:vhcs}

%---------- Motivation ----------%
\subsection{Motivation}
Most classic control architectures achieve one of two goals: equilibrium
stabilization, or tracking of a signal over time (which is known as
trajectory tracking). In fact, most trajectory-tracking controllers achieve
their results by changing a system's coordinates so that the new system is at
equilibrium if it is on the trajectory; so in fact, most control architectures
in the past have focused on equilibrium stabilization. \textbf{TODO: citation to
support this claim?}

While this is a perfectly valid approach for many systems, it is not sufficient
to provide robust, intricate motion on anything but the simplest of control
systems \textbf{TODO: citation? Can I suppport this?}. Take the example of an
autonomous vehicle driving on a road. If the desired path is a time trajectory 
and the robot experiences a disturbance, it will need to ``catch up" to the
trajectory it was following. This is a problem, because the vehicle will take
shortcuts that may take it off its original trajectory, which can cause
collisions with pedestrians, buildings, or simply cause the robot to speed down
the road.

\textbf{TODO figure with an example of this robot trajectory tracking issue}

For this reason, mobile roboticists use \textbf{path tracking}:
they define a constraint on the position of the vehicle, which does not depend on
time. Rather than catching up to where the robot is ``supposed to be" in time, a
path-tracking controller drives the robot to the nearest point on the path. This
is a much more robust control architecture, as it forces the robot to stay
within the confines of the path, so that it does not accidentally kill an
unsuspecting pedestrian.

\textbf{TODO: figure showing path tracking}

Take now the example of a walking robot. If the legs are given a trajectory in
time to follow, then the second the robot stumbles or slips it will try to
``catch up" to the trajectory and the robot will fall over \textbf{TODO: cite
grizzle. Does he make this argument too?}.  To fix this issue, one requires a
path-tracking controller for general robotic systems. An engineer should be able
to provide a constraint on the robot's configuration which does not depend on
time, and the controller should keep the robot on that constraint. This is
precisely what Virtual Holonomic Constraints attempt to accomplish.

%---------- Define VHCs ----------%
\subsection{Lagrangian Virtual Holonomic Constraints}
Take an underactuated mechanical system with Lagrangian
\begin{equation}\label{eqn:lagrangian}
\mathcal{L}(q,\dot{q}) = \frac{1}{2} \dot{q}^T D(q) \dot{q} - P(q)
\end{equation}
where \(q = (q_1,\ldots,q_n) \in \mathcal{Q}\) is the configuration vector, 
the inertia matrix \(D(q) = D^T(q) \mathbb{R}^{n \times n}\) 
is positive definite for all 
\(q \in \mathcal{Q}\), and \(P(q) \in \mathbb{R}\) is the potential of the
system.

The Euler-Lagrange equations 
\begin{equation}\label{eqn:el_eqns}
   \frac{d}{dt} \left( \frac{\partial \mathcal{L}}{\partial \dot{q}}\right) -
   \frac{\partial \mathcal{L}}{\partial q} = B(q)\tau
\end{equation}
produce the equations of motion (\ref{eqn:eom_lagrangian}), where
\(C : T\mathcal{Q} \rightarrow \mathbb{R}^{n \times n}\) represents the
generalized coriolis and centrifugal forces,
\(B : \mathcal{Q} \rightarrow \mathbb{R}^{n \times m}\) is a 
\(C^1\) full rank control matrix, and \(\tau \in \mathbb{R}^{m}\) is the control 
input. \textbf{TODO: citation for E-L equations}

\begin{equation}\label{eqn:eom_lagrangian}
D(q)\ddot{q} + C(q,\dot{q})\dot{q} + \nabla P(q) = B(q)\tau
\end{equation}

Suppose one were to use the control input \(\tau\) to enforce a
constraint on \(q\), which does not depend on \(\dot{q}\). This type of
constraint is called ``holonomic". Furthermore, since the constraint is enforced
by control as opposed to being a feature of the mechanics of the system, it is a
called a ``virtual" constraint.  This intuition leads to the following
mathematical development, as was described in \cite{vhcs_for_el_systems}:

\begin{defn}\label{defn:vhc_order_k}
   A \textbf{virtual holonomic constraint (VHC) of order k} is a smooth relation 
   \( h : \mathcal{Q} \rightarrow \mathbb{R}^k\) where
   \( \text{rank}(dh_q) = k \, \forall q \in h^{-1}(0)\) and where there exists
   a smooth feedback controller \(\tau(q,\dot{q})\) such that the constraint
   manifold
   \[
      \Gamma = \left\{ (q,\dot{q}) \in T_q\mathcal{Q} \vert h(q) = 0, \, 
      dh_q \dot{q} = 0\right\}
   \]
   is positively invariant.
\end{defn}

Typically in the theory of VHCS, one focuses mostly on VHCs of order \((n-1)\).
This is because \(h^{-1}(0) = \{q \in \mathcal{Q} \vert h(q) = 0\}\) is a
\((n-k)\)-dimensional submanifold of \(\mathcal{Q}\); if a VHC is of order
\((n-1)\), then (by the preimage theorem) once the system is on \(\Gamma\), the
set \(h^{-1}(0)\) is a 1-dimensional curve with no self-intersections which can
be parameterized by a single configuration variable. In other words, VHCs of
order \((n-1)\) reduce the dimension of the system to a 2-dimensional state,
parameterized by some new virtual configuration and its velocity.  If \(k <
(n-1)\), it becomes much more difficult to analyse the system under constraint
since it gains more degrees of freedom. Therefore it is assumed for the rest of
this section that any VHC is of order \((n-1)\).

\begin{defn}\label{defn:vhc_regular}
   A VHC \(h(q)\) of order \((n-1)\) is \textbf{regular} if 
   system (\ref{eqn:eom_lagrangian}) with output \(e = h(q)\) has vector
   relative degree \(\{2,2,\ldots,2\}\) on \(\Gamma\).
   Equivalently, a VHC is regular if and only if 
   \[
      dh_q D^{-1}(q)B(q)
   \]
   is full rank everywhere on \(\Gamma\).
\end{defn}

The definition of regularity comes from the following: 
let \(h\) be a VHC and let \(e = h(q)\) be the
output of (\ref{eqn:eom_lagrangian}). If \(h\) is regular, then
it is possible to input-output
linearize the system to get \(\ddot{e} = -k_p e - k_d \dot{e}\). This
in turn means \(\Gamma\) becomes control-invariant and asymptotically
stabilizable.

To show this, we repeat the analysis by
\textcite{vhcs_for_el_systems,lagrangian_structure_reduced_dynamics_vhcs} and take
derivatives of \(e\).

\begin{align*}
   \dot{e} &= dh_q \dot{q} \\
   \ddot{e} &= dh_q \ddot{q} + \frac{d}{dt}\left(dh_q\right)\dot{q}\\
   \Rightarrow \ddot{e} &= 
      -dh_qD^{-1}(q)\left[C(q,\dot{q})\dot{q} + \nabla P(q) \right] 
      + \begin{bmatrix}
         \dot{q}^T \nabla^2 h_1(q) \dot{q} \\
         \vdots \\
         \dot{q}^T \nabla^2 h_{n-1}(q) \dot{q}
      \end{bmatrix}
      + dh_q D^{-1}(q)B\tau \\
\end{align*}

Let \(\mu(q,\dot{q})\) be given by 
\begin{equation*}
   \mu(q,\dot{q}) := -dh_qD^{-1}(q)\left[C(q,\dot{q})\dot{q} + \nabla P(q) \right] 
      + \begin{bmatrix}
         \dot{q}^T \nabla^2 h_1(q) \dot{q} \\
         \vdots \\
         \dot{q}^T \nabla^2 h_{n-1}(q) \dot{q}
      \end{bmatrix}
\end{equation*}
Then the resulting output dynamics are
\begin{equation}\label{eqn:vhc_error_dynamics}
   \ddot{e} = \mu(q,\dot{q}) + dh_q D^{-1}B(q) \tau
\end{equation}

Since \(h\) is a regular VHC, it is possible to solve for the control input. 
The controller
\begin{equation*}
   \tau(q,\dot{q}) = \left(dh_q D^{-1}B(q)\right)^{-1}\left[-k_p e - k_d \dot{e} -
   \mu(q,\dot{q})\right]
\end{equation*}
will generate the linear output dynamics \(\ddot{e} = -k_p e - k_d\dot{e}\) 
which make \(\Gamma\) asymptotically stable.

%---------- Constrained Dynamics ----------%
\subsection{Constrained Dynamics for Lagrangian VHCs}
After constructing this controller, a natural question to ask is how system
(\ref{eqn:eom_lagrangian}) behaves once it has stabilized on the constraint
manifold \(\Gamma\). For this, one must make the following assumption.

\begin{assm}\label{assm:B_perp_exists}
   There exists \(B^\perp(q) \in \mathbb{R}^{(n-1) \times n}\) such that
   \[
      B^\perp(q) B(q) = 0 \in \mathbb{R}^{(n-1)\times(n-1)} \, \forall q \in
   \mathcal{Q}
   \]
\end{assm}

Given some \(B^\perp\), one can left-multiply the equations of motion to get
\begin{equation}\label{eqn:eom_lagrangian_with_B_perp}
   B^\perp(q)D(q)\ddot{q} + B^\perp(q)\left(C(q,\dot{q})\dot{q} \nabla
   P(q)\right) = 0
\end{equation}

Recall that, since \(h\) is a regular VHC of order \((n-1)\), the dynamics under
constraint can be parameterized by a single configuration variable.  If the
dynamics on \(\Gamma\) are non-periodic, then the curve \(h^{-1}(0)\) is
diffeomorphic to \(\mathbb{R}\). In this case, define \(\Theta := \mathbb{R}\).
Otherwise, if the dynamics on \(\Gamma\) are periodic with some period \(T > 0\), 
then the curve \(h^{-1}(0)\) is diffeomorphic to the circle
\(\mathbb{S}^1\). In this case, let \(\Theta := [\mathbb{R}]_T\).

As in \cite{lagrangian_structure_reduced_dynamics_vhcs}, 
let \(s \in \Theta\) be the virtual configuration which parameterizes
\(h^{-1}(0)\) through a diffeomorphism 
\begin{align*}
   \sigma : \Theta &\rightarrow h^{-1}(0) \\
   s &\mapsto \sigma(s) = q
\end{align*}
Likewise, the tangent bundle \(T\Theta\) is diffeomorphic to \(\Gamma\) 
through the mapping
\begin{align*}
   d\sigma : T\Theta &\rightarrow \Gamma \\
   (s,\dot{s}) &\mapsto (q,\dot{q})
\end{align*}

Using this new virtual configuration, the state of system
(\ref{eqn:eom_lagrangian}) on \(\Gamma\) 
is parameterized by \(q = \sigma(s)\) and \(\dot{q} = \sigma'(s)\dot{s}\).
Inserting these into (\ref{eqn:eom_lagrangian_with_B_perp}) (and dropping the
function notation on \(B\),\(D\),\(C\), and \(P\) for simplicity), one gets
\begin{align*}
   B^\perp D\left(\sigma'(s)\ddot{s} + \sigma"(s)\dot{s}^2 \right)
   + B^\perp \left[ C \sigma'(s)\dot{s} + \nabla P \right] = 0
\end{align*}

The matrix \(C(q,\dot{q})\) is defined element-wise by 
\begin{align*}
   [C]_{j,k} &= \sum \limits_{i=1}^n c_{i,j,k}\dot{q}_i \\
   c_{i,j,k} &= ???
\end{align*}
where \(c_{i,j,k}\) are the Christoffel symbols.
As such, one can collect the product \(B^\perp C \dot{q}\) in the following way.
First, combine the Christoffel symbols  into matrices
\(Q_i : \mathcal{Q} \rightarrow \mathbb{R}^{n \times n}\)
defined element-wise by
\begin{equation*}
   [Q_i]_{j,k}(q) = \frac{1}{2}\left(\partial_{q_k} [D]_{i,j}(q)
      + \partial_{q_j} [D]_{i,k}(q) 
      + \partial_{q_i} [D]_{k,j}(q)\right)
\end{equation*}
Then \(B^\perp C \dot{q}\) becomes
\begin{equation*}
   \sum \limits_{i=1}^n B_i^\perp \dot{q}^T Q_i
\end{equation*}

To simplify the notation, define 
\begin{align*}
   \Psi_1(s) &:= -\frac{B^\perp \nabla P}{B^\perp D \sigma'} \\
   \Psi_2(s) &:= -\frac{B^\perp D \sigma" + \sum\limits_{i=1}^n B_i^\perp
   {\sigma'}^T Q_i \sigma'}{B^\perp D \sigma'} 
\end{align*}

Hence, the constrained dynamics for any regular VHC of order \((n-1)\) are
provided entirely by the single, second-order system 
(\ref{eqn:lagrangian_constrained_dynamics}).
\begin{equation}\label{eqn:lagrangian_constrained_dynamics}
   \ddot{s} = \Psi_1(s) + \Psi_2(s)\dot{s}^2
\end{equation}

A natural question to ask is whether these constrained dynamics are also
Lagrangian. In fact, for VHCs applied to mechanical systems, the dynamics are
Euler-Lagrange. \cite{lagrangian_structure_reduced_dynamics_vhcs}

To see this, suppose the constrained dynamics had Lagrangian given by
\begin{equation}\label{eqn:vhcs_constrained_lagrangian}
   \mathcal{L}_{\Psi}(s,\dot{s}) = \frac{1}{2}
   D_{\Psi}(s)\dot{s}^2 + V_{\Psi}(s)
\end{equation}
where \(D_{\Psi} : \Theta \rightarrow \mathbb{R}_{>0}\) is the virtual mass
and \(V_{\Psi} : \Theta \rightarrow \mathbb{R}\) is the virtual potential of the
system. Then the equations of motion of this system are
\begin{equation*}
   D_{\Psi}'(s)\dot{s}^2 + D_{\Psi}(s)\ddot{s} - \frac{1}{2}D_{\Psi}'(s)\dot{s}
   + V_{\Psi}'(s) = 0
\end{equation*}
\begin{equation}\label{eqn:lagrangian_constrained_dynamics_general}
   \Rightarrow \ddot{s} = -\frac{V_{\Psi}'(s)}{D_{\Psi}(s)} -
   \frac{D_{\Psi}'(s)}{2 D_{\Psi}(s)}
\end{equation}

Setting (\ref{eqn:lagrangian_constrained_dynamics}) and
(\ref{eqn:lagrangian_constrained_dynamics_general}) equal to each other, one
can compute the values of \(D_{\Psi}\) and \(V_{\Psi}\): 
% Empty line here required for spacing

\begin{minipage}{0.48\textwidth}
\begin{align*}
   \Psi_2(s) &= -\frac{D_{\Psi}'(s)}{D_\Psi(s)} \\
   \Rightarrow D_{\Psi}'(s) &= -D_{\Psi}(s) \Psi_2(s) \\
   \Rightarrow D_{\Psi}(s) &= \exp\left[ 
   -2\int \limits_{0}^s \Psi_2(\tau) d\tau \right]
\end{align*}
\end{minipage}
% No empty lines between these
\begin{minipage}{0.48\textwidth}
\begin{align*}
   \Psi_1(s) &= -\frac{V_{\Psi}'(s)}{D_{\Psi}(s)} \\
   \Rightarrow V_{\Psi}'(s) &= -D_{\Psi}(s) \Psi_1(s) \\
   \Rightarrow V_{\Psi}(s) &= - \int \limits_{0}^s
   D_{\Psi}(\tau)\Psi_1(\tau)d\tau
\end{align*}
\end{minipage}

Thus, the constrained dynamics for mechanical systems are Euler-Lagrange with
Lagrangian (\ref{eqn:vhcs_constrained_lagrangian}).

%---------- Pros and Cons of VHCs ----------%
\subsection{Benefits and Drawbacks of VHCs}
\textbf{TODO: why are VHCs good? Who has used them? What is their downside?}

%/========== /Virtual Holonomic Constraints ==========/%
% vim: set tw=80 ts=3 sw=3 sts=0 et ffs=unix :
